<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Download dari File .torrent</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  max-width:720px;
  margin:auto;
  padding:16px;
  background:#fafafa;
}
h2{text-align:center}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:1em;
  border-radius:10px;
}
input{border:1px solid #ccc}
button{
  border:none;
  background:#2196F3;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:disabled{background:#aaa}

.status{
  background:#e3f2fd;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
}
.stats{
  background:#f1f8e9;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
  font-size:0.9em;
}
.stats div{margin:4px 0}

progress{
  width:100%;
  height:20px;
  margin-top:8px;
}

pre{
  background:#111;
  color:#0f0;
  padding:10px;
  border-radius:10px;
  height:180px;
  overflow:auto;
  font-size:12px;
}
.footer{
  text-align:center;
  font-size:0.8em;
  color:#666;
  margin-top:12px;
}
</style>
</head>
<body>

<h2>â¬‡ï¸ Download dari File .torrent</h2>

<input type="file" id="torrentInput" accept=".torrent">

<button onclick="startDownload()">Mulai Download</button>

<div class="status" id="info">â„¹ï¸ Pilih file .torrent</div>

<progress id="progress" value="0" max="100"></progress>

<div class="stats">
  <strong>ğŸ“Š Status</strong>
  <div>ğŸ“¦ File: <span id="fileCount">0</span></div>
  <div>ğŸ‘¥ Peer: <span id="peerCount">0</span></div>
  <div>â¬‡ï¸ Progress: <span id="percent">0%</span></div>
  <div>â¬†ï¸ Upload: <span id="uploaded">0 B</span></div>
  <div>âš¡ Upload speed: <span id="upSpeed">0 B/s</span></div>
</div>

<pre id="log"></pre>

<div class="footer">
Browser Torrent Â· Setelah selesai kamu otomatis ikut seeding ğŸŒ±
</div>

<script>
const client = new WebTorrent();
let uploadedBytes = 0;

const log = msg => {
  const box = document.getElementById("log");
  box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  box.scrollTop = box.scrollHeight;
};

function format(bytes){
  if(bytes > 1024*1024) return (bytes/1024/1024).toFixed(2)+" MB";
  if(bytes > 1024) return (bytes/1024).toFixed(1)+" KB";
  return bytes+" B";
}

async function startDownload(){
  const input = document.getElementById("torrentInput");
  if(!input.files.length){
    alert("Pilih file .torrent dulu");
    return;
  }

  const file = input.files[0];
  const buffer = await file.arrayBuffer();

  document.getElementById("info").textContent =
    "â¬‡ï¸ Menghubungi peer...";
  log("ğŸ“¥ Torrent dimuat: " + file.name);

  client.add(new Uint8Array(buffer), torrent=>{
    document.getElementById("fileCount").textContent =
      torrent.files.length;

    log("ğŸ§² Magnet: " + torrent.magnetURI);

    torrent.on("wire", ()=>{
      document.getElementById("peerCount").textContent =
        torrent.numPeers;
    });

    torrent.on("download", ()=>{
      const p = Math.round(torrent.progress * 100);
      document.getElementById("progress").value = p;
      document.getElementById("percent").textContent = p + "%";
      document.getElementById("info").textContent =
        "â¬‡ï¸ Download " + p + "%";
    });

    torrent.on("done", ()=>{
      log("âœ… Download selesai");
      document.getElementById("info").textContent =
        "ğŸ’¾ Menyimpan file...";

      torrent.files.forEach(f=>{
        f.getBlob((err, blob)=>{
          if(err){
            log("âŒ Gagal simpan: " + f.name);
            return;
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = f.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          log("ğŸ’¾ File tersimpan: " + f.name);
        });
      });
    });

    torrent.on("upload", bytes=>{
      uploadedBytes += bytes;
      document.getElementById("uploaded").textContent =
        format(uploadedBytes);
      document.getElementById("upSpeed").textContent =
        format(torrent.uploadSpeed)+"/s";
    });
  });
}
</script>

</body>
</html>