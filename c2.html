<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Browser Torrent Downloader (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/parse-torrent@latest/index.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  max-width:720px;
  margin:auto;
  padding:16px;
  background:#fafafa;
}
h2{text-align:center}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:1em;
  border-radius:10px;
}
input{border:1px solid #ccc}
button{
  border:none;
  background:#2196F3;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.status{
  background:#e3f2fd;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
}
.warn{
  background:#fff3cd;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
  color:#856404;
}
progress{width:100%;height:18px}
pre{
  background:#111;color:#0f0;padding:10px;border-radius:10px;
  height:160px;overflow:auto;font-size:12px;
}
</style>
</head>
<body>

<h2>‚¨áÔ∏è Browser Torrent Downloader</h2>

<input type="file" id="torrentInput" accept=".torrent">
<button onclick="start()">Mulai Download</button>

<div id="info" class="status">‚ÑπÔ∏è Pilih file .torrent</div>
<div id="warn" class="warn" style="display:none"></div>

<progress id="progress" value="0" max="100"></progress>

<pre id="log"></pre>

<script>
const client = new WebTorrent();

const WEBRTC_TRACKERS = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.fastcast.nz",
  "wss://tracker.btorrent.xyz"
];

const log = msg=>{
  const el=document.getElementById("log");
  el.textContent+=`[${new Date().toLocaleTimeString()}] ${msg}\n`;
  el.scrollTop=el.scrollHeight;
};

async function start(){
  const input=document.getElementById("torrentInput");
  if(!input.files.length){
    alert("Pilih file .torrent dulu");
    return;
  }

  const buf=await input.files[0].arrayBuffer();
  const parsed=parseTorrent(new Uint8Array(buf));

  log("üì¶ Torrent loaded");
  log("üß≤ InfoHash: "+parsed.infoHash);

  // ==== DETEKSI TRACKER ====
  const hasWebRTC =
    parsed.announce &&
    parsed.announce.some(t=>t.startsWith("wss://"));

  if(!hasWebRTC){
    document.getElementById("warn").style.display="block";
    document.getElementById("warn").innerHTML =
      "‚ö†Ô∏è Torrent ini TIDAK memiliki WebRTC tracker.<br>" +
      "Browser hanya bisa konek ke peer WebRTC.<br>" +
      "Kemungkinan besar download akan GAGAL.";
    log("‚ö†Ô∏è Tidak ada WebRTC tracker, inject manual");
  }

  // ==== INJECT TRACKER ====
  const opts={
    announce: Array.from(
      new Set([...(parsed.announce||[]), ...WEBRTC_TRACKERS])
    )
  };

  document.getElementById("info").textContent="üîé Menghubungi peer WebRTC...";
  log("üîé Connecting to peers...");

  client.add(parsed.infoHash, opts, torrent=>{
    log("üü¢ Torrent diterima WebTorrent");

    torrent.on("wire",()=>{
      document.getElementById("info").textContent=
        "üü¢ Peer ditemukan: "+torrent.numPeers;
      log("üë• Peer: "+torrent.numPeers);
    });

    torrent.on("download",()=>{
      const p=Math.round(torrent.progress*100);
      document.getElementById("progress").value=p;
      document.getElementById("info").textContent=
        "‚¨áÔ∏è Download "+p+"%";
    });

    torrent.on("done",()=>{
      log("‚úÖ Download selesai");
      document.getElementById("info").textContent="üíæ Menyimpan file";

      torrent.files.forEach(f=>{
        f.getBlob((err,blob)=>{
          if(err){
            log("‚ùå Gagal simpan "+f.name);
            return;
          }
          const a=document.createElement("a");
          a.href=URL.createObjectURL(blob);
          a.download=f.name;
          a.click();
          log("üíæ Tersimpan: "+f.name);
        });
      });
    });

    setTimeout(()=>{
      if(torrent.numPeers===0){
        document.getElementById("info").textContent=
          "‚ùå Tidak ada peer WebRTC tersedia";
        log("‚ùå 0 peer setelah 10 detik");
      }
    },10000);
  });
}
</script>

</body>
</html>