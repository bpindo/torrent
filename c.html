<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Torrent ke Magnet Converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 700px;
        margin: auto;
        padding: 20px;
        background: #f5f5f5;
    }
    h2 { text-align: center; }
    input[type="file"] {
        width: 100%;
        margin: 15px 0;
    }
    textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        font-size: 14px;
    }
    button {
        margin-top: 10px;
        padding: 10px 15px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</head>
<body>

<h2>ðŸ§² Torrent â†’ Magnet Link</h2>

<input type="file" id="torrentFile" accept=".torrent">

<textarea id="output" placeholder="Magnet link akan muncul di sini..." readonly></textarea>

<button onclick="copyMagnet()">ðŸ“‹ Copy Magnet</button>

<script>
function copyMagnet() {
    const text = document.getElementById("output");
    text.select();
    document.execCommand("copy");
    alert("Magnet link berhasil disalin!");
}

// ===== BENCODE PARSER SEDERHANA =====
function decode(data) {
    let i = 0;
    function next() {
        if (data[i] === 0x69) { // i
            i++;
            let num = '';
            while (data[i] !== 0x65) num += String.fromCharCode(data[i++]);
            i++;
            return parseInt(num);
        }
        if (data[i] === 0x6c) { // l
            i++;
            let arr = [];
            while (data[i] !== 0x65) arr.push(next());
            i++;
            return arr;
        }
        if (data[i] === 0x64) { // d
            i++;
            let obj = {};
            while (data[i] !== 0x65) {
                let key = next();
                obj[key] = next();
            }
            i++;
            return obj;
        }
        if (data[i] >= 0x30 && data[i] <= 0x39) {
            let len = '';
            while (data[i] !== 0x3a) len += String.fromCharCode(data[i++]);
            i++;
            let str = data.slice(i, i + parseInt(len));
            i += parseInt(len);
            return new TextDecoder().decode(str);
        }
    }
    return next();
}

async function sha1(buffer) {
    const hash = await crypto.subtle.digest("SHA-1", buffer);
    return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
}

document.getElementById("torrentFile").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    const buffer = await file.arrayBuffer();
    const bytes = new Uint8Array(buffer);
    const decoded = decode(bytes);

    // Encode ulang info dictionary
    function encode(obj) {
        if (typeof obj === "number") return `i${obj}e`;
        if (typeof obj === "string") return `${obj.length}:${obj}`;
        if (Array.isArray(obj)) return `l${obj.map(encode).join("")}e`;
        let keys = Object.keys(obj).sort();
        return `d${keys.map(k => encode(k) + encode(obj[k])).join("")}e`;
    }

    const infoEncoded = new TextEncoder().encode(encode(decoded["info"]));
    const infoHash = await sha1(infoEncoded);

    let magnet = `magnet:?xt=urn:btih:${infoHash}`;

    if (decoded["info"]["name"]) {
        magnet += `&dn=${encodeURIComponent(decoded["info"]["name"])}`;
    }

    if (decoded["announce"]) {
        magnet += `&tr=${encodeURIComponent(decoded["announce"])}`;
    }

    document.getElementById("output").value = magnet;
});
</script>

</body>
</html>