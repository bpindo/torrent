<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebTorrent P2P Share & Telegram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  padding:14px;
  max-width:720px;
  margin:auto;
  background:#fafafa;
}
h2{font-size:1.4em}
input,button,textarea{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:1em;
  border-radius:10px;
}
input,textarea{border:1px solid #ccc; resize:vertical;}
button{
  border:none;
  cursor:pointer;
  font-weight:600;
}
.btn-seed{background:#4CAF50;color:#fff}
.btn-copy{background:#2196F3;color:#fff}
.btn-edit{background:#9C27B0;color:#fff}
.btn-download{background:#FF9800;color:#fff}
button:disabled{background:#aaa}

.status{
  background:#e3f2fd;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
  font-size:0.95em;
}
.stats{
  background:#f1f8e9;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
  font-size:0.9em;
}
.stats div{margin:4px 0}

pre{
  background:#111;
  color:#0f0;
  padding:10px;
  border-radius:10px;
  height:200px;
  overflow:auto;
  font-size:12px;
}
#telegram-preview{
  margin-top:8px;
}
.message{
  background:#f5f5f5;
  margin-bottom:8px;
  padding:8px;
  border-radius:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.latest{background:#ffffcc;}
button.copyBtn{
  margin-left:10px;
  padding:4px 8px;
  font-size:0.9em;
  cursor:pointer;
  border:none;
  border-radius:6px;
  background:#2196F3;
  color:white;
}
button.copyBtn{
  margin-left:10px;
  padding:4px 8px;
  font-size:0.9em;
  cursor:pointer;
  border:none;
  border-radius:6px;
  background:#2196F3;
  color:white;
  width:auto;     /* tambahkan ini */
  flex-shrink:0;  /* agar tidak membesar di flex container */
}

.input-row{
  display:flex;
  gap:10px;
  align-items:center;
}
#fileInput{display:none;}
.file-btn{
  padding:10px 14px;
  border-radius:10px;
  background:#e0e0e0;
  cursor:pointer;
  font-weight:600;
  white-space:nowrap;
}

/* ===== FLOATING TORRENT STATS ===== */
#floatingStats .fs-title{
  font-weight:700;
  margin-bottom:8px;
  text-align:center;
  color:#2196F3;
  border-bottom:1px solid #e0e0e0;
  padding-bottom:6px;
}
#floatingStats .mode-download{ color:#FF9800; font-weight:600; }
#floatingStats .mode-seed{ color:#4CAF50; font-weight:600; }

#floatingStats{
  position:fixed;
  right:12px;
  bottom:20px;

  width:185px;              /* â¬…ï¸ dipersempit */
  background:#ffffff;
  color:#333;
  font-size:12px;           /* â¬…ï¸ font lebih kecil */
  border-radius:14px;

  padding:10px 12px;        /* â¬…ï¸ padding dipadatkan */
  box-shadow:0 8px 22px rgba(0,0,0,0.18);
  z-index:9999;
  line-height:1.45;

  border-left:4px solid #2196F3;
}


/* sembunyikan stats lama */
#legacyStats{
  display:none;
}


#magnet{flex:1; min-width:0;}
.btn-row{display:flex; gap:10px;}
.btn-row button{width:auto; flex:1; margin:8px 0;}
@media (max-width:520px){
  .input-row{flex-direction:column; align-items:stretch;}
}
</style>
</head>
<body>

<h2>ğŸ“¤ WebTorrent P2P Share</h2>
<div class="status">
Aplikasi web peer-to-peer berbasis <strong>WebTorrent</strong> untuk berbagi file langsung dari browser ke browser secara <strong>real-time</strong>.
</div>

<div class="input-row">
  <label class="file-btn" for="fileInput">ğŸ“ Choose File</label>
  <input type="file" id="fileInput" onchange="autoSeed()">
  <input type="text" id="magnet" placeholder="Tempel magnet / hash (BTIH)" spellcheck="false" autocomplete="off">
</div>

<div class="status" id="hashInfo" style="display:none">
  ğŸ”‘ Torrent ID: <code id="hashOnly"></code>
</div>

<div class="btn-row">
  <button class="btn-edit" id="shareBtn" onclick="shareMagnet()" disabled>ğŸ“£ Share Torrent</button>
  <button class="btn-copy" id="copyBtn" onclick="copyMagnet()" disabled>ğŸ“‹ Salin ID</button>
</div>

<button class="btn-download" onclick="download()">â¬‡ï¸ Download</button>

<div class="status">â­ Disponsori oleh <strong>Kios MadGazan</strong></div>

<!-- CHAT BOT PREVIEW -->
<div id="telegram-preview" class="log-card">Log Telegram akan muncul di sini...</div>

<div id="info" class="status">â„¹ï¸ Belum ada aktivitas</div>

<div class="stats" id="legacyStats">

  <strong>ğŸ“Š Status Torrent</strong>
  <div>ğŸŸ¢ Mode: <span id="seedStatus">Tidak aktif</span></div>
  <div>ğŸ‘¥ Peer: <span id="peerCount">0</span></div>
  <div>â¬‡ï¸ Download: <span id="downloaded">0 B</span></div>
  <div>âš¡ Download speed: <span id="downSpeed">0 B/s</span></div>
  <div>ğŸ“¦ File: <span id="fileCount">0</span></div>
  <div>â¬†ï¸ Upload total: <span id="uploaded">0 B</span></div>
  <div>âš¡ Upload speed: <span id="upSpeed">0 B/s</span></div>
</div>

<pre id="log"></pre>
<!-- FLOATING TORRENT STATUS -->
<div id="floatingStats">
  <div class="fs-title">ğŸ“Š Torrent Status</div>
  <div>ğŸŸ¢ Mode: <span id="fsMode">Idle</span></div>
  <div>ğŸ‘¥ Peer: <span id="fsPeer">0</span></div>
  <div>â¬‡ï¸ Download: <span id="fsDown">0 B</span></div>
  <div>âš¡ Speed: <span id="fsSpeed">0 B/s</span></div>
  <div>ğŸ“¦ File: <span id="fsFile">0</span></div>
  <div>â¬†ï¸ Upload: <span id="fsUp">0 B</span></div>
</div>


<script>
/* ======================
   KONFIGURASI TELEGRAM
====================== */
const TOKEN_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
const CHAT_ID_SEND = -1003689025820;
//const MESSAGE_ID_SEND = 27;

const TOKEN_LOG = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0"; // bot log
const logContainer = document.getElementById("telegram-preview");

/* ======================
   WEBTORRENT
====================== */
const TORRENT_TRACKERS = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "udp://tracker.opentrackr.org:1337",
  "udp://explodie.org:6969"
];
const client = new WebTorrent();
let currentTorrent = null;
let uploadedBytes = 0;

const log = msg => {
  const p = document.getElementById("log");
  p.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  p.scrollTop = p.scrollHeight;
};
function format(bytes){
  if(bytes>1024*1024) return (bytes/1024/1024).toFixed(2)+" MB";
  if(bytes>1024) return (bytes/1024).toFixed(1)+" KB";
  return bytes+" B";
}
function extractHash(input){
  if(!input) return null;
  const m = input.match(/btih:([a-f0-9]{40})/i);
  if(m) return m[1];
  if(/^[a-f0-9]{40}$/i.test(input)) return input;
  return null;
}
function buildMagnet(hash,name){
  let m = `magnet:?xt=urn:btih:${hash}`;
  if(name) m += `&dn=${encodeURIComponent(name)}`;
  TORRENT_TRACKERS.forEach(tr=>{ m += `&tr=${encodeURIComponent(tr)}`; });
  return m;
}

/* ======================
   COPY MAGNET
====================== */
function copyMagnet(){
  const input = document.getElementById("magnet").value.trim();
  const hash = extractHash(input);
  if(!hash) return;
  const text = `magnet:?xt=urn:btih:${hash}`;
  navigator.clipboard.writeText(text);
  log("ğŸ“‹ Torrent ID disalin");
  document.getElementById("info").textContent = "ğŸ“‹ Torrent ID disalin";
}

/* ======================
   AUTO SEED
====================== */
function autoSeed(){
  const input = document.getElementById("fileInput");
  if(!input.files.length) return;
  if(currentTorrent){ currentTorrent.destroy(); currentTorrent=null; log("â™»ï¸ Torrent sebelumnya dihentikan"); }
  const file = input.files[0]; uploadedBytes=0;
  document.getElementById("info").textContent="ğŸŒ± Membuat torrent...";
  log("ğŸ“ File dipilih: "+file.name);

  client.seed(file,torrent=>{
    currentTorrent=torrent;
    const hash=torrent.infoHash;
    document.getElementById("magnet").value=`magnet:?xt=urn:btih:${hash}`;
    document.getElementById("hashOnly").textContent=hash;
    document.getElementById("hashInfo").style.display="block";
    document.getElementById("copyBtn").disabled=false;
    document.getElementById("shareBtn").disabled=false;
    document.getElementById("seedStatus").textContent="AKTIF (Seeder)";
    document.getElementById("fileCount").textContent=torrent.files.length;
    document.getElementById("info").textContent="ğŸ§² Magnet siap & seeding aktif";
    log("ğŸ§² Magnet siap"); log("ğŸŒ± Seeding otomatis dimulai");
    bindSeederStats(torrent);
	syncFloating();

  });
}
function download(){
  const input = document.getElementById("magnet").value.trim();
  const hash = extractHash(input);
  if(!hash){ alert("Masukkan magnet atau hash yang valid"); return; }
  const magnet = buildMagnet(hash);
  client.add(magnet,torrent=>{
    currentTorrent=torrent; uploadedBytes=0;
	document.getElementById("info").textContent = "ğŸ” Mencari peer...";
	document.getElementById("seedStatus").textContent = "â³ Connecting";
    document.getElementById("info").textContent="â¬‡ï¸ Download dimulai";
    document.getElementById("seedStatus").textContent="â¬‡ï¸ Downloading";
    document.getElementById("uploaded").textContent="0 B";
    document.getElementById("upSpeed").textContent="0 B/s";
    log("â¬‡ï¸ Download dimulai");

    torrent.on("download",()=>{
	  
      const p=Math.round(torrent.progress*100);
      document.getElementById("info").textContent=`â¬‡ï¸ Download ${p}%`;
      document.getElementById("peerCount").textContent=torrent.numPeers;
      document.getElementById("downloaded").textContent=format(torrent.downloaded);
      document.getElementById("downSpeed").textContent=format(torrent.downloadSpeed)+"/s";
	  syncFloating();
    });
    torrent.on("done",()=>{
      log("âœ… Download selesai"); log("ğŸ’¾ Menyimpan file...");
      document.getElementById("info").textContent="ğŸ’¾ Menyimpan file ke browser...";
      document.getElementById("seedStatus").textContent="AKTIF (Seeder)";
	  syncFloating();

      document.getElementById("fileCount").textContent=torrent.files.length;
      torrent.files.forEach(file=>{
        file.getBlob((err,blob)=>{
          if(err){ log("âŒ Gagal simpan: "+file.name); return; }
          const url=URL.createObjectURL(blob);
          const a=document.createElement("a");
          a.href=url; a.download=file.name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
          log("ğŸ’¾ File tersimpan: "+file.name);
        });
      });
      bindSeederStats(torrent);
    });
  });
}
function bindSeederStats(torrent){
  torrent.on("wire",()=>{ document.getElementById("peerCount").textContent=torrent.numPeers; });
  torrent.on("upload",bytes=>{
	
    uploadedBytes+=bytes;
    document.getElementById("uploaded").textContent=format(uploadedBytes);
    document.getElementById("upSpeed").textContent=format(torrent.uploadSpeed)+"/s";
	document.getElementById("info").textContent = "ğŸ”— Peer ditemukan, mulai transfer...";
	syncFloating();
  });
}

function syncFloating(){
  const mode = document.getElementById("seedStatus").textContent;
  const fsMode = document.getElementById("fsMode");

  fsMode.textContent = mode;
  fsMode.className = "";

  if(mode.includes("Download")) fsMode.classList.add("mode-download");
  if(mode.includes("Seeder")) fsMode.classList.add("mode-seed");

  document.getElementById("fsPeer").textContent =
    document.getElementById("peerCount").textContent;

  document.getElementById("fsDown").textContent =
    document.getElementById("downloaded").textContent;

  document.getElementById("fsSpeed").textContent =
    document.getElementById("downSpeed").textContent;

  document.getElementById("fsFile").textContent =
    document.getElementById("fileCount").textContent;

  document.getElementById("fsUp").textContent =
    document.getElementById("uploaded").textContent;
}

/* ======================
   SHARE TORRENT â†’ KIRIM PESAN TELEGRAM
====================== */
async function shareMagnet(){
  const magnet = document.getElementById("magnet").value.trim();
  if(!magnet) return;
  const hash = extractHash(magnet);
  const text = `${hash}\n`;

  document.getElementById("info").textContent = "âœï¸ Mengirim pesan Telegram...";

  try {
    const res = await fetch(`https://api.telegram.org/bot${TOKEN_SEND}/sendMessage`,{
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        chat_id: CHAT_ID_SEND,
        text: text,
        disable_web_page_preview: true
      })
    });
    const data = await res.json();
    if(data.ok){
      log("âœ… Pesan Telegram dikirim baru");
      document.getElementById("info").textContent = "âœ… Pesan Telegram dikirim baru";
    } else {
      throw new Error(data.description);
    }

    fetchUpdates(TOKEN_LOG); // refresh log

  } catch(err){
    document.getElementById("info").textContent = "âŒ Error: " + err.message;
    log("âŒ Gagal kirim pesan: "+err.message);
  }
}


/* ======================
   AMBIL LOG BOT
====================== */
function copyText(button,text){
  navigator.clipboard.writeText(text).then(()=>{
    const oldNotif=button.parentElement.querySelector('.notif');
    if(oldNotif) oldNotif.remove();
    const span=document.createElement('span');
    span.className='notif';
    span.textContent='Tersalin!';
    button.parentElement.appendChild(span);
    setTimeout(()=>span.remove(),2000);
  });
}

function fetchUpdates(token){
  fetch(`https://api.telegram.org/bot${token}/getUpdates`)
  .then(res=>res.json())
  .then(data=>{
    if(data.result && data.result.length>0){
      const botMessages=data.result.filter(u=>{
        const msg=u.message||u.channel_post||u.edited_message;
        return msg && msg.from && msg.from.is_bot===true;
      });
      if(botMessages.length>0){
        const lastTwo=botMessages.slice(-2).reverse();
        logContainer.innerHTML=lastTwo.map((u,index)=>{
          const msg=u.message||u.channel_post||u.edited_message;
          const date=new Date(msg.date*1000).toLocaleString();
          const text=msg.text||"(non-text message)";
          const highlightClass=index===0?"latest":"";
          return `<div class="message ${highlightClass}">
                    <span>[${date}] ${text}</span>
                    <button class="copyBtn" onclick="copyText(this, \`${text.replace(/`/g,'\\`')}\`)">Copy</button>
                  </div>`;
        }).join('');
      } else logContainer.innerHTML='Tidak ada pesan dari bot.';
    } else logContainer.innerHTML='Tidak ada pesan.';
  })
  .catch(err=>{ logContainer.innerHTML='Terjadi error: '+err; });
}

// ambil log saat halaman dimuat
fetchUpdates(TOKEN_LOG);
</script>

</body>
</html>
