<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple-Peer Multi-Peer Mesh Manual Signaling</title>
<style>
  body { font-family: monospace; background:#111; color:#0f0; padding:15px; }
  textarea, input, button { width: 100%; background:#000; color:#0f0; border:1px solid #0f0; margin:8px 0; padding:8px; box-sizing: border-box; font-family: monospace;}
  button { cursor:pointer; }
  pre { background:#000; padding:10px; height: 200px; overflow-y: auto; white-space: pre-wrap; }
  .peer-section { border: 1px solid #0f0; padding: 10px; margin-bottom: 12px; }
</style>
</head>
<body>

<h2>üåê Multi-Peer Mesh Manual Signaling</h2>

<div><strong>ID Kamu:</strong> <span id="myId"></span></div>

<div class="peer-section">
  <strong>1Ô∏è‚É£ Tambah Peer</strong><br/>
  <input type="text" id="peerIdInput" placeholder="Masukkan Peer ID lain, misal: anom1234" />
  <button onclick="addPeer()">Tambah Peer & Jadi Initiator</button>
</div>

<div class="peer-section">
  <strong>2Ô∏è‚É£ Signaling untuk Peer</strong><br/>
  <textarea id="signalInput" rows="6" placeholder="Paste signaling dari peer lain di sini"></textarea>
  <button onclick="applySignal()">Apply Signaling dari Peer</button>
</div>

<div class="peer-section">
  <strong>3Ô∏è‚É£ Kirim Pesan ke Semua Peer</strong><br/>
  <input type="text" id="messageInput" placeholder="Tulis pesan di sini..." />
  <button onclick="broadcastMessage()">Kirim Pesan</button>
</div>

<div>
  <strong>üì° Log Pesan & Sistem</strong>
  <pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
  const myId = 'anom' + Math.floor(1000 + Math.random() * 9000);
  document.getElementById('myId').textContent = myId;

  const peers = {}; // { peerId: SimplePeerInstance }
  const logEl = document.getElementById('log');

  function log(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Tambah peer baru dan mulai sebagai initiator
  function addPeer() {
    const peerId = document.getElementById('peerIdInput').value.trim();
    if (!peerId) return alert('Masukkan Peer ID');

    if (peers[peerId]) {
      alert('Sudah ada koneksi dengan ' + peerId);
      return;
    }

    const peer = new SimplePeer({ initiator: true, trickle: false });
    setupPeer(peer, peerId);

    peers[peerId] = peer;

    log(`‚è≥ Membuat koneksi sebagai initiator ke ${peerId}`);
  }

  // Setup event pada peer SimplePeer
  function setupPeer(peer, peerId) {
    peer.on('signal', data => {
      const json = JSON.stringify({ from: myId, to: peerId, signal: data }, null, 2);
      log(`### Signal untuk ${peerId} (salin dan kirim ke peer ini):\n${json}`);
    });

    peer.on('connect', () => {
      log(`‚úÖ Terhubung dengan ${peerId}`);
      sendSystemMessage(peer, `Halo dari ${myId}`);
    });

    peer.on('data', data => {
      try {
        const msgObj = JSON.parse(data);
        log(`üë§ ${msgObj.from}: ${msgObj.text}`);
      } catch {
        log(`üë§ Data dari ${peerId}: ${data.toString()}`);
      }
    });

    peer.on('error', err => {
      log(`‚ùå Error dengan ${peerId}: ${err}`);
    });

    peer.on('close', () => {
      log(`‚ö†Ô∏è Koneksi dengan ${peerId} ditutup`);
      delete peers[peerId];
    });
  }

  // Apply signaling JSON yang diterima dari peer lain
  function applySignal() {
    const input = document.getElementById('signalInput').value.trim();
    if (!input) return alert('Masukkan signaling JSON');
    let obj;
    try {
      obj = JSON.parse(input);
    } catch {
      return alert('Signaling JSON tidak valid');
    }

    if (!obj.from || !obj.to || !obj.signal) {
      return alert('Format signaling salah (harus ada from, to, signal)');
    }

    // Jika belum ada peer, buat baru (receiver)
    if (!peers[obj.from]) {
      const peer = new SimplePeer({ initiator: false, trickle: false });
      setupPeer(peer, obj.from);
      peers[obj.from] = peer;
      log(`‚è≥ Menerima koneksi dari ${obj.from} (receiver)`);
    }

    peers[obj.from].signal(obj.signal);
    log(`### Signaling diterapkan untuk koneksi ${obj.from}`);

    document.getElementById('signalInput').value = '';
  }

  // Kirim pesan ke semua peer yang terkoneksi
  function broadcastMessage() {
    const msg = document.getElementById('messageInput').value.trim();
    if (!msg) return;

    const msgObj = { from: myId, text: msg };
    const jsonMsg = JSON.stringify(msgObj);

    let sentCount = 0;
    for (const peerId in peers) {
      const peer = peers[peerId];
      if (peer.connected) {
        peer.send(jsonMsg);
        sentCount++;
      }
    }

    if (sentCount === 0) {
      alert('Tidak ada peer terkoneksi untuk mengirim pesan');
      return;
    }

    log(`üó®Ô∏è Kamu (broadcast ke ${sentCount} peer): ${msg}`);
    document.getElementById('messageInput').value = '';
  }

  // Kirim pesan sistem (misal halo) ke satu peer
  function sendSystemMessage(peer, text) {
    const msgObj = { from: myId, text };
    peer.send(JSON.stringify(msgObj));
  }
</script>

</body>
</html>
