<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini WebTorrent Hybrid Peer</title>

<script src="https://cdn.jsdelivr.net/npm/webtorrent@0.115.0/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, Arial, sans-serif;
  text-align: center;
  padding: 15px;
}
input, button {
  width: 100%;
  max-width: 440px;
  margin: 6px auto;
  padding: 8px;
  box-sizing: border-box;
}
video, audio {
  width: 100%;
  max-width: 440px;
  margin-top: 10px;
}
.file {
  border-top: 1px solid #ddd;
  margin-top: 10px;
  padding-top: 10px;
}
</style>
</head>
<body>

<h3>Mini WebTorrent Hybrid Peer</h3>

<!-- SEED / UPLOAD -->
<input type="file" id="fileInput" multiple>
<p id="seedInfo"></p>

<hr>

<!-- JOIN SWARM -->
<input type="text" id="magnetInput" placeholder="Magnet / Info-hash WebTorrent">
<button id="joinBtn" disabled>Join Swarm</button>

<div id="viewer"></div>
<div id="downloads"></div>

<script>
const client = new WebTorrent();
const $ = id => document.getElementById(id);
let currentTorrent = null;

/* ========== SEED ========== */
$('fileInput').addEventListener('change', e => {
  const files = [...e.target.files];
  if (!files.length) return;

  if (currentTorrent) currentTorrent.destroy();

  client.seed(files, torrent => {
    currentTorrent = torrent;
    $('seedInfo').textContent = `Seeding ${files.length} file`;
    $('magnetInput').value = torrent.magnetURI;
    $('joinBtn').disabled = false;
  });
});

/* ENABLE JOIN */
$('magnetInput').oninput = () => {
  $('joinBtn').disabled = !$('magnetInput').value.trim();
};

/* ========== JOIN / STREAM / DOWNLOAD ========== */
$('joinBtn').onclick = () => {
  const magnet = $('magnetInput').value.trim();
  if (!magnet) return;

  client.add(magnet, torrent => {

    torrent.files.forEach(file => {
      const box = document.createElement('div');
      box.className = 'file';

      // STREAMING (HEMAT RAM)
      if (file.name.match(/\.(mp4|webm|mp3)$/i)) {
        const media = document.createElement(
          file.name.match(/mp3$/) ? 'audio' : 'video'
        );
        media.controls = true;
        file.appendTo(media);
        box.appendChild(media);
      }

      // DOWNLOAD MANUAL
      const btn = document.createElement('button');
      btn.textContent = `Download ${file.name}`;

      btn.onclick = () => {
        btn.textContent = 'Menyiapkan file...';
        file.getBlob((_, blob) => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = file.name;
          a.click();
          btn.textContent = 'Download ulang';
        });
      };

      box.appendChild(btn);
      downloads.appendChild(box);
    });

  });
};

client.on('error', console.error);
</script>

</body>
</html>
