<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebTorrent P2P Share</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  padding:14px;
  max-width:720px;
  margin:auto;
  background:#fafafa;
}
h2{font-size:1.4em}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:1em;
  border-radius:10px;
}
input{border:1px solid #ccc}
button{
  border:none;
  cursor:pointer;
  font-weight:600;
}
.btn-seed{background:#4CAF50;color:#fff}
.btn-copy{background:#2196F3;color:#fff}
.btn-download{background:#FF9800;color:#fff}
button:disabled{background:#aaa}

.status{
  background:#e3f2fd;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
  font-size:0.95em;
}
.stats{
  background:#f1f8e9;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
  font-size:0.9em;
}
.stats div{margin:4px 0}

pre{
  background:#111;
  color:#0f0;
  padding:10px;
  border-radius:10px;
  height:200px;
  overflow:auto;
  font-size:12px;
}

.chat-box{
  background:#000;
  color:#0f0;
  padding:8px;
  border-radius:8px;
  height:140px;
  overflow:auto;
  font-size:12px;
  margin-bottom:6px;
}

.footer{
  text-align:center;
  font-size:0.8em;
  color:#666;
  margin-top:10px;
}
</style>
</head>
<body>

<h2>ğŸ“¤ WebTorrent P2P Share</h2>

<div class="status">
Upload â†’ Seed â†’ Share Magnet â†’ Download â†’ <strong>Ikut Seeding</strong>
</div>

<input type="file" id="fileInput">
<button class="btn-seed" onclick="seedFile()">ğŸŒ± Mulai Seeding</button>

<input id="magnet" placeholder="Magnet URI muncul di sini">

<button class="btn-seed" id="shareBtn" onclick="shareMagnet()" disabled>
ğŸš€ Share Magnet
</button>

<button class="btn-copy" id="copyBtn" onclick="copyMagnet()" disabled>
ğŸ“‹ Salin Magnet
</button>

<button class="btn-download" onclick="download()">â¬‡ï¸ Download dari Magnet</button>

<div id="info" class="status">â„¹ï¸ Belum ada aktivitas</div>

<div class="stats">
  <strong>ğŸ“Š Status Torrent</strong>
  <div>ğŸŸ¢ Mode: <span id="seedStatus">Tidak aktif</span></div>
  <div>ğŸ‘¥ Peer: <span id="peerCount">0</span></div>
  <div>ğŸ“¦ File: <span id="fileCount">0</span></div>
  <div>â¬†ï¸ Upload total: <span id="uploaded">0 B</span></div>
  <div>âš¡ Upload speed: <span id="upSpeed">0 B/s</span></div>
</div>

<pre id="log"></pre>

<!-- ===== CHAT UI ===== -->
<div class="stats">
  <strong>ğŸ’¬ P2P Chat (Seeder)</strong>
  <div id="chatBox" class="chat-box"></div>
  <input id="chatInput" placeholder="Ketik pesan ke sesama seederâ€¦" disabled>
  <button onclick="sendChat()" id="chatSend" disabled>ğŸ“¨ Kirim</button>
</div>

<div class="footer">
Browser Torrent Â· Selama tab terbuka, kamu adalah seeder ğŸŒ±
</div>

<script>
const client = new WebTorrent();
let currentTorrent = null;
let uploadedBytes = 0;

// ===== CHAT STATE =====
const peerName = "Peer-" + Math.random().toString(36).slice(2,6);
let chatWires = [];

const log = msg => {
  const p = document.getElementById("log");
  p.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  p.scrollTop = p.scrollHeight;
};

function format(bytes){
  if(bytes > 1024*1024) return (bytes/1024/1024).toFixed(2)+" MB";
  if(bytes > 1024) return (bytes/1024).toFixed(1)+" KB";
  return bytes+" B";
}

// ===== CHAT UI =====
function addChat(msg){
  const box = document.getElementById("chatBox");
  box.innerHTML += msg + "<br>";
  box.scrollTop = box.scrollHeight;
}

function sendChat(){
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if(!text || !chatWires.length) return;

  const payload = JSON.stringify({
    from: peerName,
    text: text
  });

  chatWires.forEach(wire=>{
    try{ wire.extended("chat", payload); }catch(e){}
  });

  addChat(`<b>${peerName}</b>: ${text}`);
  input.value = "";
}

// ===== COPY MAGNET =====
function copyMagnet(){
  const magnet = document.getElementById("magnet").value;
  if(!magnet) return;
  navigator.clipboard.writeText(magnet);
  log("ğŸ“‹ Magnet disalin");
  document.getElementById("info").textContent = "ğŸ“‹ Magnet disalin";
}

// ===== SEED FILE =====
function seedFile(){
  const input = document.getElementById("fileInput");
  if(!input.files.length){
    alert("Pilih file dulu");
    return;
  }

  const file = input.files[0];
  uploadedBytes = 0;

  document.getElementById("info").textContent = "ğŸŒ± Membuat torrent...";
  log("ğŸ“ File: "+file.name);

  client.seed(file, torrent=>{
    currentTorrent = torrent;
    document.getElementById("magnet").value = torrent.magnetURI;
    document.getElementById("copyBtn").disabled = false;
    document.getElementById("shareBtn").disabled = false;

    document.getElementById("seedStatus").textContent = "AKTIF (Seeder)";
    document.getElementById("fileCount").textContent = torrent.files.length;

    log("ğŸ§² Magnet siap");
    log("ğŸŒ± Seeding dimulai");

    bindSeederStats(torrent);
  });
}

// ===== DOWNLOAD =====
function download(){
  const magnet = document.getElementById("magnet").value.trim();
  if(!magnet){
    alert("Paste magnet dulu");
    return;
  }

  client.add(magnet, torrent=>{
    currentTorrent = torrent;
    uploadedBytes = 0;

    document.getElementById("info").textContent = "â¬‡ï¸ Download dimulai";
    log("â¬‡ï¸ Download dimulai");

    bindSeederStats(torrent);

    torrent.on("download", ()=>{
      const p = Math.round(torrent.progress*100);
      document.getElementById("info").textContent =
        `â¬‡ï¸ Download ${p}% Â· Seeding aktif`;
    });

    torrent.on("done", ()=>{
      document.getElementById("seedStatus").textContent =
        "AKTIF (Full Seeder)";
      document.getElementById("info").textContent =
        "ğŸŒ± Download selesai Â· Full seeding";
    });
  });
}

// ===== STATS + CHAT INJECTION =====
function bindSeederStats(torrent){
  torrent.on("wire", wire=>{
    document.getElementById("peerCount").textContent =
      torrent.numPeers;

    log("ğŸ”— Peer terhubung ("+torrent.numPeers+")");

    chatWires.push(wire);

    wire.use({
      name: "chat",
      onMessage: data=>{
        try{
          const msg = JSON.parse(data.toString());
          addChat(`<b>${msg.from}</b>: ${msg.text}`);
        }catch(e){}
      }
    });

    document.getElementById("chatInput").disabled = false;
    document.getElementById("chatSend").disabled = false;

    addChat(`<i>ğŸ”— Peer baru terhubung</i>`);
  });

  torrent.on("upload", bytes=>{
    uploadedBytes += bytes;
    document.getElementById("uploaded").textContent =
      format(uploadedBytes);
    document.getElementById("upSpeed").textContent =
      format(torrent.uploadSpeed)+"/s";
  });
}

// ===== SHARE MAGNET (UNTOUCHED) =====
async function shareMagnet(){
  alert("âš ï¸ Token Telegram masih di frontend (demo only)");
}
</script>

</body>
</html>