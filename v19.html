<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebTorrent P2P Share & Telegram - Mobile Friendly</title>

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bpindo/p2p-helper@main/style.css">

<style>
  /* Style tambahan untuk kolom update log */
  #update-log {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #ddd;
    background: #f9f9f9;
    height: 150px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 13px;
    white-space: pre-wrap;
  }
  #update-log .log-entry {
    margin-bottom: 4px;
    border-bottom: 1px solid #eee;
    padding-bottom: 2px;
  }
</style>
</head>
<body>

<h2>ğŸ“¤ WebTorrent P2P Share</h2>

<div class="status">
  Aplikasi web peer-to-peer berbasis <strong>WebTorrent</strong> untuk berbagi file langsung dari browser ke browser secara <strong>real-time</strong>.
</div>

<div class="input-row">
  <label class="file-btn" for="fileInput">ğŸ“ Choose File</label>
  <input type="file" id="fileInput" onchange="autoSeed()" />
  <input type="text" id="magnet" placeholder="Tempel magnet / hash (BTIH)" spellcheck="false" autocomplete="off" />
</div>

<input type="hidden" id="hashOnly" />

<div class="btn-row">
  <button class="btn-edit hidden" id="shareBtn" onclick="shareMagnet()">ğŸ“£ Share Torrent</button>
  <button class="btn-copy hidden" id="copyBtn" onclick="copyMagnet()">ğŸ“‹ Salin ID </button>
</div>

<div id="telegram-preview" class="log-card">Log Telegram akan muncul di sini...</div>
<button class="btn-download hidden" id="downloadBtn" onclick="download()">â¬‡ï¸ Download</button>

<div id="info" class="status">â„¹ï¸ Belum ada aktivitas</div>

<div class="stats" id="legacyStats" style="display: none;">
  <strong>ğŸ“Š Status Torrent</strong>
  <div>ğŸŸ¢ Mode: <span id="seedStatus">Tidak aktif</span></div>
  <div>ğŸ‘¥ Peer: <span id="peerCount">0</span></div>
  <div>â¬‡ï¸ Download: <span id="downloaded">0 B</span></div>
  <div>âš¡ Download speed: <span id="downSpeed">0 B/s</span></div>
  <div>ğŸ“¦ File: <span id="fileCount">0</span></div>
  <div>â¬†ï¸ Upload total: <span id="uploaded">0 B</span></div>
  <div>âš¡ Upload speed: <span id="upSpeed">0 B/s</span></div>
</div>

<pre id="log" style="display: none;"></pre>

<!-- Kolom update log baru di bawah -->
<div id="update-log" aria-live="polite" aria-atomic="true" role="log" aria-relevant="additions">
  <strong>Update Log</strong>
  <br>
</div>

<script>
  /* ======================
     KONFIGURASI TELEGRAM
  ===================== */
  const TOKEN_SEND = "8384730708:AAHjPCLYpW7wz2B5-jBxMJ17-kH1G1zXZuY";
  const CHAT_ID_SEND = -1003689025820;

  const TOKEN_LOG = "359218339:AAF7KH-T3ihEPvHfWPJge_Ax9PdV9GQw2W0"; // bot log
  const logContainer = document.getElementById("telegram-preview");

  /* ======================
     WEBTORRENT
  ===================== */
  const TORRENT_TRACKERS = [
    "wss://tracker.openwebtorrent.com",
    "wss://tracker.btorrent.xyz",
    "udp://tracker.opentrackr.org:1337",
    "udp://explodie.org:6969"
  ];
  const client = new WebTorrent();
  let currentTorrent = null;

  const log = msg => {
    const p = document.getElementById("log");
    p.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    p.scrollTop = p.scrollHeight;
  };

  // Fungsi tambahan untuk update log realtime
  function appendUpdateLog(msg) {
    const container = document.getElementById("update-log");
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement("div");
    entry.className = "log-entry";
    entry.textContent = `[${time}] ${msg}`;
    container.appendChild(entry);
    container.scrollTop = container.scrollHeight;
  }

  function format(bytes) {
    if (bytes > 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + " MB";
    if (bytes > 1024) return (bytes / 1024).toFixed(1) + " KB";
    return bytes + " B";
  }

  function extractHash(input) {
    if (!input) return null;
    const m = input.match(/btih:([a-f0-9]{40})/i);
    if (m) return m[1];
    if (/^[a-f0-9]{40}$/i.test(input)) return input;
    return null;
  }

  function buildMagnet(hash, name) {
    let m = `magnet:?xt=urn:btih:${hash}`;
    if (name) m += `&dn=${encodeURIComponent(name)}`;
    TORRENT_TRACKERS.forEach(tr => {
      m += `&tr=${encodeURIComponent(tr)}`;
    });
    return m;
  }

  function copyMagnet() {
    const input = document.getElementById("magnet").value.trim();
    const hash = extractHash(input);
    if (!hash) return;
    const text = `magnet:?xt=urn:btih:${hash}`;
    navigator.clipboard.writeText(text);
    log("ğŸ“‹ Torrent ID disalin");
    document.getElementById("info").textContent = "ğŸ“‹ Torrent ID disalin";
  }

  function autoSeed() {
    const fileInput = document.getElementById("fileInput");
    const magnetInput = document.getElementById("magnet");
    const hashOnlyEl = document.getElementById("hashOnly");

    if (!fileInput.files.length) return;

    const file = fileInput.files[0];
    log("ğŸ“ File dipilih: " + file.name);

    if (currentTorrent) {
      try { currentTorrent.destroy(); } catch {}
      currentTorrent = null;
    }

    client.seed(file, torrent => {
      currentTorrent = torrent;

      const hash = torrent.infoHash;

      hashOnlyEl.value = hash;
      magnetInput.value = `magnet:?xt=urn:btih:${hash}`;

      log("ğŸ§² Torrent siap (hash dibuat)");
      log("ğŸŒ± Seeding otomatis dimulai");

      document.getElementById("info").textContent = "ğŸŸ¢ Mode: AKTIF (Seeder) - Menunggu peer...";
      appendUpdateLog("Seeder aktif: Menunggu peer...");

      shareMagnet(true, hash);

      document.getElementById("downloadBtn").classList.add("hidden");

      torrent.on("wire", () => {
        log("ğŸ‘¥ Peer terhubung");
        document.getElementById("info").textContent = "ğŸ”— Peer terhubung, mulai upload/download...";
        appendUpdateLog("Peer terhubung");
      });

      torrent.on("upload", bytes => {
        log(`â¬†ï¸ Mengunggah ${format(bytes)} ke peer`);
        document.getElementById("info").textContent = `â¬†ï¸ Mengunggah data ke peer (${format(torrent.uploadSpeed)}/s)`;
        appendUpdateLog(`Upload ${format(bytes)} ke peer (${format(torrent.uploadSpeed)}/s)`);
      });

      torrent.on("error", e => {
        log("âŒ Torrent error: " + e.message);
        document.getElementById("info").textContent = "âŒ Error torrent: " + e.message;
        appendUpdateLog(`Error torrent: ${e.message}`);
      });
    });
  }

  function showManualButtons() {
    document.getElementById("shareBtn")?.classList.remove("hidden");
    document.getElementById("copyBtn")?.classList.remove("hidden");
  }

  function download() {
    const input = document.getElementById("magnet").value.trim();
    const hash = extractHash(input);
    if (!hash) {
      alert("Masukkan magnet atau hash yang valid");
      return;
    }
    const magnet = buildMagnet(hash);

    client.add(magnet, torrent => {
      currentTorrent = torrent;
      let uploadedBytes = 0;

      document.getElementById("info").textContent = "ğŸ” Mencari peer...";
      document.getElementById("seedStatus").textContent = "â³ Connecting";
      document.getElementById("info").textContent = "â¬‡ï¸ Download dimulai";
      document.getElementById("seedStatus").textContent = "â¬‡ï¸ Downloading";
      document.getElementById("uploaded").textContent = "0 B";
      document.getElementById("upSpeed").textContent = "0 B/s";

      log("â¬‡ï¸ Download dimulai");
      appendUpdateLog("Download dimulai");

      torrent.on("download", () => {
        const p = Math.round(torrent.progress * 100);
        const infoEl = document.getElementById("info");

        infoEl.textContent = `â¬‡ï¸ Download ${p}%`;
        if (p === 100) {
          infoEl.textContent += `\nğŸŒ± Sekarang menjadi seeder, upload ${format(torrent.uploaded)}`;
          appendUpdateLog(`Download selesai, sekarang menjadi seeder. Upload: ${format(torrent.uploaded)}`);
        }

        document.getElementById("peerCount").textContent = torrent.numPeers;
        document.getElementById("downloaded").textContent = format(torrent.downloaded);
        document.getElementById("downSpeed").textContent = format(torrent.downloadSpeed) + "/s";
        syncFloating();
      });

      torrent.on("done", () => {
        log("âœ… Download selesai");
        log("ğŸ’¾ Menyimpan file...");
        document.getElementById("info").textContent = `ğŸ’¾ Download selesai. ğŸŒ± Sekarang menjadi seeder, upload ${format(torrent.uploaded)}`;
        document.getElementById("seedStatus").textContent = "ğŸŸ¢ AKTIF (Seeder)";
        syncFloating();

        document.getElementById("fileCount").textContent = torrent.files.length;

        torrent.files.forEach(file => {
          file.getBlob((err, blob) => {
            if (err) {
              log("âŒ Gagal simpan: " + file.name);
              appendUpdateLog(`Gagal simpan file: ${file.name}`);
              return;
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            log("ğŸ’¾ File tersimpan: " + file.name);
            appendUpdateLog(`File tersimpan: ${file.name}`);
          });
        });

        bindSeederStats(torrent);
      });

      torrent.on("error", e => {
        log("âŒ Torrent error: " + e.message);
        document.getElementById("info").textContent = "âŒ Error torrent: " + e.message;
        appendUpdateLog(`Error torrent: ${e.message}`);
      });
    });
  }

  function bindSeederStats(torrent) {
    torrent.on("wire", () => {
      const peerCount = torrent.numPeers;
      document.getElementById("peerCount").textContent = peerCount;
      log(`ğŸ‘¥ Peer terhubung: ${peerCount}`);
      document.getElementById("info").textContent = `ğŸ”— Peer terhubung: ${peerCount}`;
      appendUpdateLog(`Peer terhubung: ${peerCount}`);
    });

    let uploadedBytes = 0;
    torrent.on("upload", bytes => {
      uploadedBytes += bytes;
      document.getElementById("uploaded").textContent = format(uploadedBytes);
      document.getElementById("upSpeed").textContent = format(torrent.uploadSpeed) + "/s";
      document.getElementById("info").textContent = `â¬†ï¸ Mengunggah ${format(bytes)} ke peer (${format(torrent.uploadSpeed)}/s)`;
      appendUpdateLog(`Upload ${format(bytes)} ke peer (${format(torrent.uploadSpeed)}/s)`);
      syncFloating();
    });

    torrent.on("done", () => {
      log("âœ… Seeder aktif, upload siap");
      document.getElementById("seedStatus").textContent = "ğŸŸ¢ AKTIF (Seeder)";
      document.getElementById("info").textContent = "ğŸŸ¢ Seeder aktif, siap upload ke peer";
      appendUpdateLog("Seeder aktif, siap upload ke peer");
      syncFloating();
    });

    torrent.on("error", err => {
      log("âŒ Error seeding: " + err.message);
      document.getElementById("info").textContent = "âŒ Error: " + err.message;
      appendUpdateLog(`Error seeding: ${err.message}`);
    });
  }

  function syncFloating() {
    const mode = document.getElementById("seedStatus").textContent;
    const fsMode = document.getElementById("fsMode");

    if (!fsMode) return;

    fsMode.textContent = mode;
    fsMode.className = "";

    if (mode.includes("Download")) fsMode.classList.add("mode-download");
    if (mode.includes("Seeder")) fsMode.classList.add("mode-seed");

    document.getElementById("fsPeer").textContent =
      document.getElementById("peerCount").textContent;

    document.getElementById("fsDown").textContent =
      document.getElementById("downloaded").textContent;

    document.getElementById("fsSpeed").textContent =
      document.getElementById("downSpeed").textContent;

    document.getElementById("fsFile").textContent =
      document.getElementById("fileCount").textContent;

    document.getElementById("fsUp").textContent =
      document.getElementById("uploaded").textContent;
  }

  async function shareMagnet(auto = false, hashOverride = null) {
    const shareBtn = document.getElementById("shareBtn");

    const hash =
      hashOverride ||
      document.getElementById("hashOnly")?.value ||
      extractHash(document.getElementById("magnet").value);

    if (!hash) {
      log("âŒ Share gagal: hash belum siap");
      return;
    }

    const text = `${hash}\n`;

    log(auto ? "ğŸ¤– Auto-share hash..." : "ğŸ“£ Share hash...");

    if (auto && shareBtn) {
      shareBtn.disabled = true;
    }

    await fetch(`https://api.telegram.org/bot${TOKEN_SEND}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: CHAT_ID_SEND,
        text
      })
    });

    log("âœ… Hash terkirim");

    if (auto && shareBtn) {
      shareBtn.disabled = true;
    }
  }

  function copyText(button, text) {
    navigator.clipboard.writeText(text).then(() => {
      setMagnetAsDownloader(text);
      showDownloadButtonIfValid();

      const oldNotif = button.parentElement.querySelector(".notif");
      if (oldNotif) oldNotif.remove();

      const span = document.createElement("span");
      span.className = "notif";
      span.textContent = "âœ” Magnet masuk";
      button.parentElement.appendChild(span);

      setTimeout(() => span.remove(), 2000);
    });
  }

  function fetchUpdates(token) {
    fetch(`https://api.telegram.org/bot${token}/getUpdates`)
      .then(res => res.json())
      .then(data => {
        if (data.result && data.result.length > 0) {
          const botMessages = data.result.filter(u => {
            const msg = u.message || u.channel_post || u.edited_message;
            return msg && msg.from && msg.from.is_bot === true;
          });
          if (botMessages.length > 0) {
            const messages = botMessages.slice(-1).reverse();

            logContainer.innerHTML = messages
              .map(u => {
                const msg = u.message || u.channel_post || u.edited_message;
                const text = msg.text || "";
                return `
                  <div class="message">
                    <span>${text}</span>
                    <button class="copyBtn" onclick="copyText(this, \`${text.replace(/`/g, "\\`")}\`)">
                      Copy
                    </button>
                  </div>
                `;
              })
              .join("");

          } else logContainer.innerHTML = "Tidak ada pesan dari bot.";
        } else logContainer.innerHTML = "Tidak ada pesan.";
      })
      .catch(err => {
        logContainer.innerHTML = "Terjadi error: " + err;
      });
  }

  fetchUpdates(TOKEN_LOG);

  setInterval(() => {
    console.log("Refreshing Telegram logs...");
    fetchUpdates(TOKEN_LOG);
  }, 10000);

  function setMagnetAsDownloader(text) {
    const hash = extractHash(text);
    if (!hash) {
      alert("Teks yang dicopy bukan hash/magnet valid");
      return;
    }

    const magnetInput = document.getElementById("magnet");
    magnetInput.value = `magnet:?xt=urn:btih:${hash}`;

    document.getElementById("info").textContent = "ğŸ“¥ Magnet diterima, siap download";
    document.getElementById("seedStatus").textContent = "â¬‡ï¸ Siap Download";
    syncFloating();

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function showDownloadButtonIfValid() {
    const magnetInput = document.getElementById("magnet");
    const downloadBtn = document.getElementById("downloadBtn");

    const hash = extractHash(magnetInput.value.trim());
    if (hash) {
      downloadBtn.classList.remove("hidden");
    } else {
      downloadBtn.classList.add("hidden");
    }
  }

  document.getElementById("magnet").addEventListener("input", () => {
    showManualButtons();
    showDownloadButtonIfValid();
  });
</script>

</body>
</html>
