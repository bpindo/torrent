<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Share File JSON via Torrent</title>
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  padding:20px;
  max-width:700px;
  margin:auto;
}
h2{margin-bottom:5px}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
.status{
  background:#eef;
  padding:10px;
  border-radius:6px;
  margin-top:8px;
  font-size:0.9em;
}
.btn-copy{
  background:#4CAF50;
  color:white;
  border:none;
  cursor:pointer;
}
.btn-copy:disabled{
  background:#aaa;
}
pre{
  background:#111;
  color:#0f0;
  padding:10px;
  height:220px;
  overflow:auto;
  font-size:12px;
}
</style>
</head>
<body>

<h2>ğŸ“¤ Bagikan File (contoh: aku.json)</h2>
<p class="status">
Upload file â†’ otomatis jadi torrent â†’ dapat magnet â†’ dibagikan
</p>

<input type="file" id="fileInput">
<button onclick="seedFile()">ğŸŒ± Bagikan File</button>

<input id="magnet" placeholder="Magnet URI akan muncul di sini">

<button class="btn-copy" id="copyBtn" onclick="copyMagnet()" disabled>
ğŸ“‹ Salin Magnet
</button>

<button onclick="download()">â¬‡ï¸ Download dari Magnet</button>

<div id="info" class="status">â„¹ï¸ Belum ada aktivitas</div>

<pre id="log"></pre>

<script>
const client = new WebTorrent();
let currentTorrent = null;

const log = msg => {
  const p = document.getElementById("log");
  p.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  p.scrollTop = p.scrollHeight;
};

// =======================
// COPY MAGNET
// =======================
function copyMagnet(){
  const magnet = document.getElementById("magnet").value;

  if(!magnet){
    alert("Magnet belum tersedia");
    return;
  }

  if(navigator.clipboard){
    navigator.clipboard.writeText(magnet).then(() => {
      log("ğŸ“‹ Magnet disalin ke clipboard");
      document.getElementById("info").textContent =
        "ğŸ“‹ Magnet berhasil disalin";
    }).catch(() => fallbackCopy(magnet));
  } else {
    fallbackCopy(magnet);
  }
}

function fallbackCopy(text){
  const temp = document.createElement("textarea");
  temp.value = text;
  document.body.appendChild(temp);
  temp.select();
  document.execCommand("copy");
  document.body.removeChild(temp);

  log("ğŸ“‹ Magnet disalin (fallback)");
  document.getElementById("info").textContent =
    "ğŸ“‹ Magnet berhasil disalin";
}

// =======================
// SEED FILE UPLOAD
// =======================
function seedFile(){
  const input = document.getElementById("fileInput");

  if(!input.files.length){
    alert("Pilih file dulu (contoh: aku.json)");
    return;
  }

  const file = input.files[0];

  document.getElementById("info").textContent =
    "ğŸŒ± Membuat torrent dari file...";

  log("ğŸ“ File dipilih: " + file.name);
  log("ğŸ“ Ukuran: " + file.size + " byte");

  client.seed(file, torrent => {
    currentTorrent = torrent;

    document.getElementById("magnet").value = torrent.magnetURI;
    document.getElementById("copyBtn").disabled = false;

    document.getElementById("info").textContent =
      "ğŸŒ± Seeding aktif | Magnet siap dibagikan";

    log("ğŸ§² Magnet dibuat");
    log("ğŸŒ± Seeding dimulai");

    torrent.on("wire", () => {
      log("ğŸ”— Peer terhubung");
      document.getElementById("info").textContent =
        "ğŸ”— Peer terhubung | Seeding berjalan";
    });

    torrent.on("upload", bytes => {
      log("â¬†ï¸ Upload " + bytes + " byte");
    });
  });
}

// =======================
// DOWNLOAD + AUTO SAVE
// =======================
function download(){
  const magnet = document.getElementById("magnet").value.trim();
  if(!magnet){
    alert("Paste magnet dulu");
    return;
  }

  client.add(magnet, torrent => {
    currentTorrent = torrent;

    document.getElementById("info").textContent =
      "â¬‡ï¸ Download dimulai...";

    log("â¬‡ï¸ Download dimulai");

    torrent.on("download", () => {
      const percent = Math.round(torrent.progress * 100);
      document.getElementById("info").textContent =
        `â¬‡ï¸ Download ${percent}% | ${(torrent.downloadSpeed/1024).toFixed(1)} KB/s`;
    });

    torrent.on("done", () => {
      log("âœ… Download selesai");

      document.getElementById("info").textContent =
        "ğŸ’¾ Menyimpan file ke komputer...";

      torrent.files.forEach(file => {
        file.getBlob((err, blob) => {
          if(err){
            log("âŒ Gagal ambil file");
            return;
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = file.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          log("ğŸ’¾ File tersimpan: " + file.name);
        });
      });

      document.getElementById("info").textContent =
        "âœ… Download selesai & file tersimpan";
    });
  });
}
</script>

</body>
</html>
