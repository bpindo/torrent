<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>P2P Chat Bubble UI (Light)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f4f6f8;
  color: #222;
  padding: 14px;
  max-width: 720px;
  margin: auto;
}

h3 {
  margin-bottom: 6px;
}

#chat {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 12px;
  height: 360px;
  overflow-y: auto;
  margin: 10px 0;
}

.bubble {
  max-width: 75%;
  padding: 8px 12px;
  margin: 6px 0;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
}

.me {
  background: #d1f7c4;
  color: #0b3d0b;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.peer {
  background: #f0f0f0;
  color: #222;
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.system {
  background: #eef1f4;
  color: #666;
  font-size: 12px;
  text-align: center;
  margin: 8px auto;
  border-radius: 8px;
  max-width: 90%;
}

.name {
  font-size: 11px;
  color: #777;
  margin-bottom: 2px;
}

input, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 14px;
}

input {
  background: #fff;
}

button {
  background: #2ecc71;
  color: #fff;
  border: none;
  font-weight: 600;
}

button:disabled {
  background: #bcdcc8;
}
</style>
</head>

<body>

<h3>üåê P2P Chat</h3>
<div><b>ID kamu:</b> <span id="id"></span></div>

<div id="chat"></div>

<input id="msg" placeholder="Tulis pesan..." disabled>
<button id="sendBtn" disabled>Kirim</button>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

<script>
/* ================= ID ================= */
const myId = "user" + Math.floor(Math.random() * 10000);
document.getElementById("id").textContent = myId;

const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");

/* ================= UI ================= */
function addBubble(text, type, from = "") {
  const wrap = document.createElement("div");

  if (type === "system") {
    wrap.className = "bubble system";
    wrap.textContent = text;
  } else {
    if (type === "peer") {
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = from;
      wrap.appendChild(name);
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble " + type;
    bubble.textContent = text;
    wrap.appendChild(bubble);
  }

  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

/* ================= SIGNALING ================= */
const SIGNALING_HOST = "p2p-chat-production-3693.up.railway.app";
const WS_URL = location.protocol === "https:"
  ? "wss://" + SIGNALING_HOST
  : "ws://" + SIGNALING_HOST;

addBubble("üîå Menghubungkan signaling...", "system");

const ws = new WebSocket(WS_URL);
const peers = {};

ws.onopen = () => {
  addBubble("‚úÖ Signaling terhubung", "system");
  ws.send(JSON.stringify({ type: "register", id: myId }));
};

ws.onmessage = e => {
  const data = JSON.parse(e.data);

  if (data.type === "peers") {
    data.peers.forEach(pid => {
      if (pid === myId || peers[pid]) return;
      createPeer(pid);
    });
    return;
  }

  if (data.signal) {
    if (!peers[data.from]) createPeer(data.from);
    peers[data.from].signal(data.signal);
  }
};

/* ================= PEER ================= */
function createPeer(pid) {
  addBubble("‚è≥ Menghubungkan ke " + pid, "system");

  const peer = new SimplePeer({
    initiator: myId < pid,
    trickle: false
  });

  peers[pid] = peer;

  peer.on("signal", s => {
    ws.send(JSON.stringify({ from: myId, to: pid, signal: s }));
  });

  peer.on("connect", () => {
    addBubble("‚úÖ Terhubung dengan " + pid, "system");
    updateUI();
  });

  peer.on("data", d => {
    addBubble(d.toString(), "peer", pid);
  });

  peer.on("close", () => {
    addBubble("‚ö†Ô∏è Terputus dari " + pid, "system");
    delete peers[pid];
    updateUI();
  });

  peer.on("error", () => {
    addBubble("‚ùå Error koneksi ke " + pid, "system");
  });
}

/* ================= SEND ================= */
sendBtn.onclick = () => {
  const text = msgInput.value.trim();
  if (!text) return;

  let sent = 0;
  Object.values(peers).forEach(p => {
    if (p.connected) {
      p.send(text);
      sent++;
    }
  });

  if (sent) {
    addBubble(text, "me");
  } else {
    addBubble("‚ö†Ô∏è Tidak ada peer siap", "system");
  }

  msgInput.value = "";
};

/* ================= UI ================= */
function updateUI() {
  const ready = Object.values(peers).some(p => p.connected);
  msgInput.disabled = !ready;
  sendBtn.disabled = !ready;
}
</script>

</body>
</html>
