<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>P2P Chat â€“ WhatsApp Style</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
:root{
  --wa-green:#008069;
  --wa-bg:#efeae2;
  --me:#d9fdd3;
  --peer:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:var(--wa-bg);
  display:flex;
  justify-content:center;
}

/* APP */
.app{
  width:100%;
  max-width:520px;
  height:100dvh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:var(--wa-green);
  color:#fff;
  padding:10px 14px;
  font-size:14px;
  font-weight:600;
}

/* CHAT */
#chat{
  flex:1;                     /* ðŸ”¥ INI KUNCI */
  padding:8px 10px;
  overflow-y:auto;
}

/* ROW */
.row{display:flex;margin-bottom:4px}
.me-row{justify-content:flex-end}
.peer-row{justify-content:flex-start}
.sys-row{justify-content:center}

/* BUBBLE */
.bubble{
  max-width:78%;
  padding:7px 10px;
  font-size:14px;
  line-height:1.4;
  border-radius:10px;
  box-shadow:0 1px 1px rgba(0,0,0,.1);
  white-space:pre-wrap;
}

.me{background:var(--me);border-top-right-radius:4px}
.peer{background:var(--peer);border-top-left-radius:4px}
.system{
  background:#e4e6e8;
  font-size:11px;
  color:#555;
  padding:4px 8px;
  border-radius:6px;
}

/* FOOTER (NO FIXED!) */
footer{
  background:#f0f2f5;
  padding:6px 8px env(safe-area-inset-bottom);
  display:flex;
  gap:6px;
}

/* INPUT */
textarea{
  flex:1;
  resize:none;
  max-height:80px;
  padding:8px 12px;
  border-radius:18px;
  border:1px solid #ccc;
  font-size:14px;
  line-height:1.3;
}

button{
  background:var(--wa-green);
  color:#fff;
  border:none;
  border-radius:50%;
  width:38px;
  height:38px;
  font-size:16px;
}

button:disabled{opacity:.4}
</style>
</head>

<body>

<div class="app">

<header>P2P Chat</header>

<div id="chat"></div>

<footer>
  <textarea id="msg" rows="1" placeholder="Tulis pesanâ€¦" disabled></textarea>
  <button id="send" disabled>âž¤</button>
</footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
const myId="user"+Math.floor(Math.random()*10000);
const chat=document.getElementById("chat");
const msg=document.getElementById("msg");
const send=document.getElementById("send");

function addBubble(t,type){
  const r=document.createElement("div");
  r.className="row "+type+"-row";
  const b=document.createElement("div");
  b.className="bubble "+type;
  b.textContent=t;
  r.appendChild(b);
  chat.appendChild(r);
  chat.scrollTop=chat.scrollHeight;
}

/* SIGNALING */
const HOST="p2p-chat-production-3693.up.railway.app";
const WS=location.protocol==="https:"?"wss://"+HOST:"ws://"+HOST;
addBubble("Menghubungkanâ€¦","system");

const ws=new WebSocket(WS);
const peers={};

ws.onopen=()=>{
  addBubble("Server terhubung","system");
  ws.send(JSON.stringify({type:"register",id:myId}));
};

ws.onmessage=e=>{
  const d=JSON.parse(e.data);
  if(d.type==="peers"){
    d.peers.forEach(p=>p!==myId&&!peers[p]&&createPeer(p));
    return;
  }
  if(d.signal){
    if(!peers[d.from])createPeer(d.from);
    peers[d.from].signal(d.signal);
  }
};

function createPeer(pid){
  addBubble("Menghubungkan ke "+pid,"system");
  const peer=new SimplePeer({initiator:myId<pid,trickle:false});
  peers[pid]=peer;

  peer.on("signal",s=>ws.send(JSON.stringify({from:myId,to:pid,signal:s})));
  peer.on("connect",()=>{
    peer.ready=true;
    addBubble("Terhubung dengan "+pid,"system");
    updateUI();
  });
  peer.on("data",d=>addBubble(d.toString(),"peer"));
  peer.on("close",()=>{
    addBubble("Terputus dari "+pid,"system");
    delete peers[pid];
    updateUI();
  });
}

/* SEND */
function sendMsg(){
  const t=msg.value.trim();
  if(!t)return;
  Object.values(peers).forEach(p=>p.ready&&p.send(t));
  addBubble(t,"me");
  msg.value="";
  msg.style.height="auto";
}

send.onclick=sendMsg;

msg.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault();
    sendMsg();
  }
});

msg.addEventListener("input",()=>{
  msg.style.height="auto";
  msg.style.height=Math.min(msg.scrollHeight,80)+"px";
});

function updateUI(){
  const r=Object.values(peers).some(p=>p.ready);
  msg.disabled=!r;
  send.disabled=!r;
}
</script>

</body>
</html>
