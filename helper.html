<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Voluntary P2P Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  max-width: 720px;
  margin: auto;
  padding: 20px;
}
h1 { font-size: 1.4rem; }
button {
  background: #22c55e;
  color: #052e16;
  border: none;
  padding: 12px 18px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
}
button.off {
  background: #ef4444;
  color: white;
}
.card {
  background: #020617;
  padding: 16px;
  border-radius: 12px;
  margin-top: 15px;
}
.small { font-size: 0.9rem; opacity: 0.8; }
.list { margin-top: 10px; }
.list div { margin-bottom: 6px; }
</style>
</head>

<body>

<h1>ðŸ§  Voluntary P2P Helper</h1>
<p class="small">
Dengan mengaktifkan, browser Anda membantu distribusi konten populer
secara aman & terbatas.
</p>

<button id="toggle">Aktifkan Bantuan</button>

<div class="card">
  <div>Status: <b id="status">Menunggu</b></div>
  <div>Data terkirim: <b id="uploaded">0 KB</b></div>
  <div>Peer aktif: <b id="peers">0</b></div>
  <div>Potensi hemat server: <b id="saving">0 GB / hari</b></div>
</div>

<div class="card">
  <b>Konten prioritas:</b>
  <div id="list" class="list small">Memuat dataâ€¦</div>
</div>

<script>
const POPULAR_JSON_URL = "./popular.json";
const STORAGE_KEY = "p2p_helper_active";

const ANNOUNCE = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.fastcast.nz"
];

let client;
let totalUploaded = 0;
let totalPeers = 0;

const statusEl = document.getElementById("status");
const uploadedEl = document.getElementById("uploaded");
const peersEl = document.getElementById("peers");
const savingEl = document.getElementById("saving");
const listEl = document.getElementById("list");
const btn = document.getElementById("toggle");

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + " KB";
  if (bytes < 1024*1024*1024) return (bytes/1024/1024).toFixed(1) + " MB";
  return (bytes/1024/1024/1024).toFixed(2) + " GB";
}

function stopHelper() {
  localStorage.removeItem(STORAGE_KEY);
  if (client) client.destroy();
  btn.textContent = "Aktifkan Bantuan";
  btn.classList.remove("off");
  statusEl.textContent = "Nonaktif";
}

async function startHelper() {
  btn.textContent = "Matikan Bantuan";
  btn.classList.add("off");
  statusEl.textContent = "Memuat dataâ€¦";

  localStorage.setItem(STORAGE_KEY, "1");
  client = new WebTorrent();

  let res;
  try {
    res = await fetch(POPULAR_JSON_URL);
  } catch {
    statusEl.textContent = "Gagal memuat data";
    return;
  }

  const data = await res.json();
  if (!data.articles || !data.articles.length) {
    listEl.textContent = "Data populer belum ada";
    return;
  }

  // hitung potensi hemat
  let saving = 0;
  data.articles.forEach(a => {
    saving += (a.sizeMB * a.dailyViews) / 1024;
  });
  savingEl.textContent = saving.toFixed(1) + " GB / hari";

  // urutkan paling berat
  data.articles.sort((a,b) =>
    (b.sizeMB*b.dailyViews)-(a.sizeMB*a.dailyViews)
  );

  listEl.innerHTML = "";
  data.articles.forEach(a => {
    const d = document.createElement("div");
    d.textContent = "â€¢ " + a.title;
    listEl.appendChild(d);

    client.add(a.magnet, { announce: ANNOUNCE }, torrent => {
      torrent.on("wire", () => {
        totalPeers++;
        peersEl.textContent = totalPeers;
        statusEl.textContent = "Aktif membantu";
      });

      torrent.on("upload", bytes => {
        totalUploaded += bytes;
        uploadedEl.textContent = formatBytes(totalUploaded);
      });
    });
  });
}

btn.onclick = () => {
  if (localStorage.getItem(STORAGE_KEY)) {
    stopHelper();
  } else {
    startHelper();
  }
};

// AUTO START jika pernah aktif
if (localStorage.getItem(STORAGE_KEY)) {
  startHelper();
}
</script>

</body>
</html>