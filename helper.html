<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Bantu Website Tetap Gratis</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, Arial, sans-serif;
  max-width: 560px;
  margin: auto;
  padding: 20px;
  line-height: 1.6;
  color: #111;
}
h1 { font-size: 22px; }
button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  margin-top: 12px;
}
.box {
  background: #f4f4f4;
  padding: 12px;
  margin-top: 15px;
  border-radius: 6px;
}
.small {
  font-size: 13px;
  color: #555;
}
ul { padding-left: 18px; }
</style>
</head>

<body>

<h1>ü§ù Bantu Website Tetap Gratis</h1>

<p>
Dengan mengaktifkan halaman ini, browser Anda membantu
<strong>mengirimkan konten publik</strong>
kepada pengunjung lain.
</p>

<p>
‚úî Aman & anonim<br>
‚úî Tanpa login<br>
‚úî Bisa dihentikan kapan saja
</p>

<button id="toggle">Aktifkan Bantuan</button>

<div class="box">
  <div><strong>Status:</strong> <span id="state">Tidak aktif</span></div>
  <div><strong>Data terkirim:</strong> <span id="sent">0</span> KB</div>
  <div><strong>Potensi hemat server:</strong> <span id="saving">0</span> GB / hari</div>
</div>

<div class="box small">
<strong>Konten yang dibantu:</strong>
<ul id="list"></ul>
</div>

<script>
/* =======================
   KONFIGURASI
======================= */
const POPULAR_JSON_URL = "./popular.json"; // pastikan bisa dibuka
const MAX_HELP = 10;
const UPLOAD_LIMIT = 600 * 1024; // 600 KB/s

/* =======================
   STATE
======================= */
let client = null;
let active = false;
let uploaded = 0;

/* =======================
   ELEMENT
======================= */
const btn = document.getElementById("toggle");
const stateEl = document.getElementById("state");
const sentEl = document.getElementById("sent");
const savingEl = document.getElementById("saving");
const listEl = document.getElementById("list");

/* =======================
   LOAD POPULAR.JSON (AMAN)
======================= */
async function loadPopular() {
  try {
    const res = await fetch(POPULAR_JSON_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (!data.articles || !data.articles.length) {
      throw new Error("Data kosong");
    }
    return data;
  } catch (err) {
    console.error("popular.json error:", err);
    stateEl.textContent = "Data populer belum tersedia";
    return null;
  }
}

/* =======================
   TOGGLE HELPER
======================= */
btn.onclick = async () => {
  if (active) {
    client.destroy();
    client = null;
    active = false;
    btn.textContent = "Aktifkan Bantuan";
    stateEl.textContent = "Tidak aktif";
    return;
  }

  stateEl.textContent = "Memuat data‚Ä¶";
  btn.textContent = "Hentikan Bantuan";

  const data = await loadPopular();
  if (!data) {
    btn.textContent = "Aktifkan Bantuan";
    return;
  }

  client = new WebTorrent({ uploadLimit: UPLOAD_LIMIT });
  active = true;

  const ranked = data.articles
    .map(a => ({
      ...a,
      savingScore: a.sizeMB * a.dailyViews
    }))
    .sort((a, b) => b.savingScore - a.savingScore)
    .slice(0, MAX_HELP);

  const totalSavingMB = ranked.reduce(
    (sum, a) => sum + a.savingScore, 0
  );
  savingEl.textContent = (totalSavingMB / 1024).toFixed(1);

  listEl.innerHTML = "";
  ranked.forEach(a => {
    const li = document.createElement("li");
    li.textContent =
      `${a.title} (¬±${(a.savingScore / 1024).toFixed(1)} GB/hari)`;
    listEl.appendChild(li);
  });

  ranked.forEach(article => {
    client.add(article.magnet, torrent => {
      stateEl.textContent = "Aktif membantu";
      torrent.on("upload", bytes => {
        uploaded += bytes;
        sentEl.textContent = Math.round(uploaded / 1024);
      });
    });
  });
};
</script>

</body>
</html>