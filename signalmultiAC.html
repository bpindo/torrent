<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple-Peer Manual Signaling (Auto Initiator)</title>
<style>
  body { font-family: monospace; background:#111; color:#0f0; padding:15px; }
  textarea, input, button {
    width:100%; background:#000; color:#0f0;
    border:1px solid #0f0; margin:8px 0; padding:8px;
    box-sizing:border-box; font-family: monospace;
  }
  button { cursor:pointer; }
  pre {
    background:#000; padding:10px; height:200px;
    overflow-y:auto; white-space:pre-wrap;
  }
  .peer-section {
    border:1px solid #0f0; padding:10px; margin-bottom:12px;
  }
  .row {
    display:flex; gap:6px;
  }
</style>
</head>
<body>

<h2>üåê Manual Signaling (Auto Initiator)</h2>

<div><strong>ID Kamu:</strong> <span id="myId"></span></div>

<div class="peer-section">
  <strong>1Ô∏è‚É£ Buat Offer</strong><br/>
  <button onclick="createOffer()">Buat Offer (Initiator)</button>
</div>

<div class="peer-section">
  <strong>2Ô∏è‚É£ Signaling</strong><br/>
  <textarea id="signalBox" rows="6" placeholder="Offer / Answer akan muncul di sini atau paste dari peer"></textarea>
  <div class="row">
    <button onclick="applySignal()">Apply Signaling</button>
    <button onclick="copySignal()">Copy</button>
  </div>
</div>

<div class="peer-section">
  <strong>3Ô∏è‚É£ Kirim Pesan (Broadcast)</strong><br/>
  <input id="messageInput" placeholder="Tulis pesan di sini..." />
  <button onclick="broadcastMessage()">Kirim Pesan</button>
</div>

<div class="peer-section">
  <strong>üì° Log Sistem</strong><br/>
  <pre id="log"></pre>
  <button onclick="copyLog()">Copy Log</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
const myId = 'anom' + Math.floor(1000 + Math.random() * 9000);
document.getElementById('myId').textContent = myId;

let peer = null;
const peers = {};
const logEl = document.getElementById('log');
const signalBox = document.getElementById('signalBox');

function log(msg){
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

// 1Ô∏è‚É£ Auto initiator
function createOffer(){
  if(peer) return alert("Peer sudah dibuat");

  peer = new SimplePeer({ initiator:true, trickle:false });
  setupPeer(peer, "remote");
  peers["remote"] = peer;

  log("‚è≥ Membuat offer...");
}

function setupPeer(p, peerId){
  p.on('signal', data=>{
    const json = JSON.stringify({ from:myId, signal:data }, null, 2);
    signalBox.value = json;
    log("üì§ Signal siap dikirim");
  });

  p.on('connect', ()=>{
    log("‚úÖ Peer terhubung");
    sendSystemMessage(p, "Halo dari " + myId);
  });

  p.on('data', data=>{
    try {
      const m = JSON.parse(data);
      log(`üë§ ${m.from}: ${m.text}`);
    } catch {
      log("üë§ Data: " + data);
    }
  });

  p.on('error', err=>log("‚ùå Error: " + err));
  p.on('close', ()=>log("‚ö†Ô∏è Peer disconnect"));
}

// 2Ô∏è‚É£ Apply signaling
function applySignal(){
  let obj;
  try { obj = JSON.parse(signalBox.value); }
  catch { return alert("JSON tidak valid"); }

  if(!peer){
    peer = new SimplePeer({ initiator:false, trickle:false });
    setupPeer(peer, obj.from || "remote");
  }

  peer.signal(obj.signal);
  log("üì• Signaling diterapkan");
  signalBox.value = "";
}

// 3Ô∏è‚É£ Broadcast
function broadcastMessage(){
  const msg = messageInput.value.trim();
  if(!msg || !peer || !peer.connected) return;

  peer.send(JSON.stringify({ from:myId, text:msg }));
  log("üó®Ô∏è Kamu: " + msg);
  messageInput.value = "";
}

// Utils
function sendSystemMessage(p, text){
  p.send(JSON.stringify({ from:myId, text }));
}

function copySignal(){
  navigator.clipboard.writeText(signalBox.value);
  alert("Signaling disalin");
}

function copyLog(){
  navigator.clipboard.writeText(logEl.textContent);
  alert("Log disalin");
}
</script>

</body>
</html>