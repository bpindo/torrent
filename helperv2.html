<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Voluntary P2P Helper â€“ MAX SEED MODE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #020617;
  color: #e5e7eb;
  max-width: 720px;
  margin: auto;
  padding: 20px;
}
h1 { font-size: 1.4rem; }
input, button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  font-size: 1rem;
}
input {
  background: #020617;
  border: 1px solid #334155;
  color: #e5e7eb;
}
button {
  background: #22c55e;
  color: #052e16;
  border: none;
  cursor: pointer;
  font-weight: 600;
}
button.off {
  background: #ef4444;
  color: white;
}
.card {
  background: #020617;
  border: 1px solid #1e293b;
  padding: 16px;
  border-radius: 12px;
  margin-top: 14px;
}
.small { font-size: 0.9rem; opacity: 0.85; }
.list div { margin-bottom: 6px; }
</style>
</head>

<body>

<h1>ðŸ§  Voluntary P2P Helper</h1>
<p class="small">
MAX SEED MODE â€” browser Anda berfungsi sebagai seeder WebRTC agresif.
</p>

<button id="toggle">Aktifkan MAX SEED</button>

<div class="card">
  <div>Status: <b id="status">Idle</b></div>
  <div>Upload: <b id="uploaded">0 KB</b></div>
  <div>Peer aktif: <b id="peers">0</b></div>
</div>

<div class="card">
  <b>Seeder Otomatis</b>
  <div id="list" class="small">Menunggu dataâ€¦</div>
</div>

<div class="card">
  <b>Tambah Magnet / Hash Manual</b>
  <input id="manualMagnet" placeholder="magnet:?xt=urn:btih:xxxx atau hash BTIH">
  <button id="addMagnet">Tambah & Seed</button>
  <div id="manualStatus" class="small"></div>
</div>

<script>
/* ================= CONFIG ================= */

const POPULAR_JSON_URL = "./popular.json";
const STORAGE_KEY = "p2p_helper_active";
const MANUAL_KEY = "p2p_manual_magnets";

const ANNOUNCE = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.fastcast.nz",
  "wss://tracker.webtorrent.dev",
  "wss://tracker.files.fm:7073/announce"
];

/* ================= STATE ================= */

let client;
let totalUploaded = 0;
let totalPeers = 0;
let activeMagnets = new Set();

/* ================= UI ================= */

const statusEl = document.getElementById("status");
const uploadedEl = document.getElementById("uploaded");
const peersEl = document.getElementById("peers");
const listEl = document.getElementById("list");
const btn = document.getElementById("toggle");
const manualInput = document.getElementById("manualMagnet");
const manualStatus = document.getElementById("manualStatus");

/* ================= UTILS ================= */

function formatBytes(b) {
  if (b < 1024) return b + " B";
  if (b < 1024*1024) return (b/1024).toFixed(1) + " KB";
  if (b < 1024*1024*1024) return (b/1024/1024).toFixed(1) + " MB";
  return (b/1024/1024/1024).toFixed(2) + " GB";
}

function normalizeMagnet(v) {
  v = v.trim();
  if (v.startsWith("magnet:?xt=urn:btih:")) return v;
  if (/^[a-fA-F0-9]{40}$/.test(v)) {
    return "magnet:?xt=urn:btih:" + v;
  }
  return null;
}

/* ================= SEED CORE ================= */

function maxSeed(torrent) {
  torrent.files.forEach(f => f.select());
  torrent.critical(0, torrent.pieces.length - 1);

  torrent.on("wire", () => {
    totalPeers++;
    peersEl.textContent = totalPeers;
    statusEl.textContent = "Seeding aktif";
  });

  torrent.on("upload", b => {
    totalUploaded += b;
    uploadedEl.textContent = formatBytes(totalUploaded);
  });

  torrent.on("done", () => torrent.resume());
  torrent.on("noPeers", () => torrent.resume());
}

/* ================= STORAGE ================= */

function saveManual(m) {
  const arr = JSON.parse(localStorage.getItem(MANUAL_KEY) || "[]");
  if (!arr.includes(m)) {
    arr.push(m);
    localStorage.setItem(MANUAL_KEY, JSON.stringify(arr));
  }
}

function loadManual() {
  return JSON.parse(localStorage.getItem(MANUAL_KEY) || "[]");
}

/* ================= MAIN ================= */

async function startHelper() {
  btn.textContent = "Matikan MAX SEED";
  btn.classList.add("off");
  statusEl.textContent = "Inisialisasiâ€¦";

  localStorage.setItem(STORAGE_KEY, "1");

  client = new WebTorrent({
    uploadLimit: 0,
    downloadLimit: 0
  });

  // otomatis
  try {
    const res = await fetch(POPULAR_JSON_URL);
    const data = await res.json();
    listEl.innerHTML = "";

    data.articles?.forEach(a => {
      listEl.innerHTML += `<div>â€¢ ${a.title}</div>`;
      if (!activeMagnets.has(a.magnet)) {
        activeMagnets.add(a.magnet);
        client.add(a.magnet, { announce: ANNOUNCE, store: false }, maxSeed);
      }
    });
  } catch {
    listEl.textContent = "Gagal memuat data otomatis";
  }

  // manual restore
  loadManual().forEach(m => {
    if (!activeMagnets.has(m)) {
      activeMagnets.add(m);
      client.add(m, { announce: ANNOUNCE, store: false }, maxSeed);
    }
  });
}

function stopHelper() {
  localStorage.removeItem(STORAGE_KEY);
  if (client) client.destroy();
  activeMagnets.clear();
  btn.textContent = "Aktifkan MAX SEED";
  btn.classList.remove("off");
  statusEl.textContent = "Nonaktif";
}

/* ================= EVENTS ================= */

btn.onclick = () => {
  localStorage.getItem(STORAGE_KEY) ? stopHelper() : startHelper();
};

document.getElementById("addMagnet").onclick = () => {
  if (!client) {
    manualStatus.textContent = "Aktifkan helper dulu.";
    return;
  }

  const magnet = normalizeMagnet(manualInput.value);
  if (!magnet) {
    manualStatus.textContent = "Format magnet / hash tidak valid.";
    return;
  }

  if (activeMagnets.has(magnet)) {
    manualStatus.textContent = "Torrent sudah diseding.";
    return;
  }

  activeMagnets.add(magnet);
  saveManual(magnet);

  client.add(magnet, { announce: ANNOUNCE, store: false }, maxSeed);
  manualStatus.textContent = "Seeder aktif & disimpan.";
  manualInput.value = "";
};

// auto start
if (localStorage.getItem(STORAGE_KEY)) startHelper();
</script>

</body>
</html>
