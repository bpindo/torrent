<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple-Peer P2P Chat Example</title>
<style>
  body {
    font-family: monospace;
    background: #111;
    color: #0f0;
    padding: 15px;
  }
  textarea, input, button {
    width: 100%;
    font-family: monospace;
    background: #000;
    color: #0f0;
    border: 1px solid #0f0;
    margin: 8px 0;
    padding: 8px;
    box-sizing: border-box;
  }
  button {
    cursor: pointer;
  }
  pre {
    background: #000;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
  }
  .btn-row {
    display: flex;
    gap: 8px;
  }
  .btn-row button {
    flex: 1;
  }
</style>
</head>
<body>

<h2>üåê Simple-Peer Manual Signaling Chat</h2>

<div>
  <strong>1Ô∏è‚É£ Pilih Mode</strong><br/>
  <div class="btn-row">
    <button onclick="start(true)">Start sebagai Initiator (A)</button>
    <button onclick="start(false)">Start sebagai Receiver (B/C)</button>
  </div>
</div>

<div>
  <strong>2Ô∏è‚É£ Tukar Signaling</strong><br/>
  <textarea id="signal" rows="8" placeholder="Copy/Paste signaling JSON disini..."></textarea>
  <button onclick="applySignal()">Apply Signal</button>
</div>

<div>
  <strong>3Ô∏è‚É£ Kirim Pesan</strong><br/>
  <input type="text" id="messageInput" placeholder="Tulis pesan di sini..." />
  <button onclick="sendMessage()">Kirim Pesan</button>
</div>

<div>
  <strong>üì° Log Pesan & Sistem</strong>
  <pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
  let peer = null;

  function log(msg) {
    const logEl = document.getElementById('log');
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function start(initiator) {
    if (peer) {
      peer.destroy();
      peer = null;
      log('### Peer sebelumnya dihancurkan');
    }
    peer = new SimplePeer({ initiator, trickle: false });

    peer.on('signal', data => {
      document.getElementById('signal').value = JSON.stringify(data, null, 2);
      log(`### Signal dibuat (salin & kirim ke peer lain)`);
    });

    peer.on('connect', () => {
      log('‚úÖ CONNECTED - Sekarang bisa kirim pesan');
    });

    peer.on('data', data => {
      const msg = data.toString();
      log(`üë§ Peer: ${msg}`);
    });

    peer.on('error', err => {
      log('‚ùå Error: ' + err);
    });

    peer.on('close', () => {
      log('‚ö†Ô∏è Koneksi ditutup');
    });

    log(`‚è≥ Peer dibuat sebagai ${initiator ? 'Initiator' : 'Receiver'}`);
  }

  function applySignal() {
    if (!peer) {
      alert('Mulai peer dulu dengan pilih mode di atas!');
      return;
    }
    try {
      const signalData = JSON.parse(document.getElementById('signal').value);
      peer.signal(signalData);
      log('### Signal diterapkan');
    } catch(e) {
      alert('JSON signaling tidak valid!');
      log('‚ùå Gagal parse signaling JSON');
    }
  }

  function sendMessage() {
    const input = document.getElementById('messageInput');
    if (!peer || !peer.connected) {
      alert('Peer belum terkoneksi!');
      return;
    }
    const msg = input.value.trim();
    if (!msg) return;
    peer.send(msg);
    log(`üó®Ô∏è Kamu: ${msg}`);
    input.value = '';
  }
</script>

</body>
</html>
