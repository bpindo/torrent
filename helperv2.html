<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Voluntary P2P Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  max-width: 720px;
  margin: auto;
  padding: 20px;
}
h1 { font-size: 1.4rem; }
input, button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  font-size: 1rem;
}
input {
  border: 1px solid #334155;
  background: #020617;
  color: #e5e7eb;
}
button {
  background: #22c55e;
  color: #052e16;
  border: none;
  cursor: pointer;
}
button.off {
  background: #ef4444;
  color: white;
}
.card {
  background: #020617;
  padding: 16px;
  border-radius: 12px;
  margin-top: 15px;
}
.small { font-size: 0.9rem; opacity: 0.8; }
.magnet-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 6px 0;
  word-break: break-all;
}
.magnet-item input {
  width: auto;
}
</style>
</head>

<body>

<h1>ðŸ§  Voluntary P2P Helper</h1>
<p class="small">
Pilih konten mana saja yang ingin Anda bantu distribusinya.
</p>

<button id="toggle">Aktifkan Bantuan</button>

<div class="card">
  <div>Status: <b id="status">Menunggu</b></div>
  <div>Upload: <b id="uploaded">0 KB</b></div>
  <div>Peer aktif: <b id="peers">0</b></div>
</div>

<div class="card">
  <b>Magnet Tersimpan (Checklist)</b>
  <div id="magnetList" class="small">Belum ada magnet</div>
</div>

<div class="card">
  <b>Tambah Magnet / Hash</b>
  <input id="manualMagnet"
    placeholder="magnet:?xt=urn:btih:xxxx atau hash 40 karakter">
  <button id="addMagnet">Simpan Magnet</button>
  <div id="manualStatus" class="small"></div>
</div>

<script>
const STORAGE_KEY = "p2p_helper_active";
const MAGNET_KEY = "p2p_magnet_map";

const ANNOUNCE = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.fastcast.nz"
];

let client;
let totalUploaded = 0;
let totalPeers = 0;
let torrents = {};

const statusEl = document.getElementById("status");
const uploadedEl = document.getElementById("uploaded");
const peersEl = document.getElementById("peers");
const btn = document.getElementById("toggle");
const magnetListEl = document.getElementById("magnetList");
const manualInput = document.getElementById("manualMagnet");
const manualStatus = document.getElementById("manualStatus");

function formatBytes(b) {
  if (b < 1024) return b + " B";
  if (b < 1024*1024) return (b/1024).toFixed(1) + " KB";
  return (b/1024/1024).toFixed(1) + " MB";
}

function normalizeMagnet(v) {
  v = v.trim();
  if (v.startsWith("magnet:?xt=urn:btih:")) return v;
  if (/^[a-fA-F0-9]{40}$/.test(v)) {
    return "magnet:?xt=urn:btih:" + v;
  }
  return null;
}

function loadMagnetMap() {
  return JSON.parse(localStorage.getItem(MAGNET_KEY) || "{}");
}

function saveMagnetMap(map) {
  localStorage.setItem(MAGNET_KEY, JSON.stringify(map));
}

function renderMagnetList() {
  const map = loadMagnetMap();
  magnetListEl.innerHTML = "";

  const keys = Object.keys(map);
  if (!keys.length) {
    magnetListEl.textContent = "Belum ada magnet tersimpan";
    return;
  }

  keys.forEach(magnet => {
    const row = document.createElement("div");
    row.className = "magnet-item";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = map[magnet];

    cb.onchange = () => {
      map[magnet] = cb.checked;
      saveMagnetMap(map);
      cb.checked ? seedMagnet(magnet) : unseedMagnet(magnet);
    };

    const label = document.createElement("span");
    label.textContent = magnet.replace("magnet:?xt=urn:btih:", "");

    row.append(cb, label);
    magnetListEl.appendChild(row);
  });
}

function seedMagnet(magnet) {
  if (!client || torrents[magnet]) return;

  client.add(magnet, { announce: ANNOUNCE }, torrent => {
    torrents[magnet] = torrent;

    torrent.on("wire", () => {
      totalPeers++;
      peersEl.textContent = totalPeers;
      statusEl.textContent = "Aktif membantu";
    });

    torrent.on("upload", b => {
      totalUploaded += b;
      uploadedEl.textContent = formatBytes(totalUploaded);
    });
  });
}

function unseedMagnet(magnet) {
  if (torrents[magnet]) {
    torrents[magnet].destroy();
    delete torrents[magnet];
  }
}

function startHelper() {
  client = new WebTorrent();
  statusEl.textContent = "Aktif";
  btn.textContent = "Matikan Bantuan";
  btn.classList.add("off");

  const map = loadMagnetMap();
  Object.entries(map).forEach(([m, enabled]) => {
    if (enabled) seedMagnet(m);
  });
}

function stopHelper() {
  if (client) client.destroy();
  torrents = {};
  btn.textContent = "Aktifkan Bantuan";
  btn.classList.remove("off");
  statusEl.textContent = "Nonaktif";
}

btn.onclick = () => {
  localStorage.getItem(STORAGE_KEY)
    ? (localStorage.removeItem(STORAGE_KEY), stopHelper())
    : (localStorage.setItem(STORAGE_KEY, "1"), startHelper());
};

document.getElementById("addMagnet").onclick = () => {
  const magnet = normalizeMagnet(manualInput.value);
  if (!magnet) {
    manualStatus.textContent = "Format magnet / hash tidak valid.";
    return;
  }

  const map = loadMagnetMap();
  if (magnet in map) {
    manualStatus.textContent = "Magnet sudah tersimpan.";
    return;
  }

  map[magnet] = true;
  saveMagnetMap(map);
  renderMagnetList();
  if (client) seedMagnet(magnet);

  manualInput.value = "";
  manualStatus.textContent = "Magnet disimpan & diaktifkan.";
};

renderMagnetList();
if (localStorage.getItem(STORAGE_KEY)) startHelper();
</script>

</body>
</html>
