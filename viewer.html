<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Viewer Konten P2P</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #020617;
  color: #e5e7eb;
  max-width: 760px;
  margin: auto;
  padding: 20px;
}
h1 { font-size: 1.4rem; }
.card {
  background: #0f172a;
  padding: 16px;
  border-radius: 12px;
  margin-top: 15px;
}
.progress {
  height: 10px;
  background: #020617;
  border-radius: 6px;
  overflow: hidden;
  margin-top: 8px;
}
.bar {
  height: 100%;
  width: 0%;
  background: #38bdf8;
  transition: width 0.3s;
}
.small {
  font-size: 0.9rem;
  opacity: 0.85;
  margin-top: 6px;
}
.file {
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>ðŸ“„ Viewer Konten Terdistribusi</h1>
<p class="small">
Konten ini dimuat menggunakan jaringan <b>P2P browser (WebTorrent)</b>.
Jika ada helper aktif, unduhan akan lebih cepat.
</p>

<div id="content"></div>

<script>
const POPULAR_JSON_URL = "./popular.json";

const ANNOUNCE = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.fastcast.nz"
];

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + " MB";
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + " GB";
}

const client = new WebTorrent();
const container = document.getElementById("content");

fetch(POPULAR_JSON_URL)
.then(res => res.json())
.then(data => {

  if (!data.articles || !data.articles.length) {
    container.textContent = "Konten belum tersedia.";
    return;
  }

  // Ambil konten prioritas teratas
  const article = data.articles[0];

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <b>${article.title}</b>
    <div class="small" id="stat">
      0% â€¢ menunggu piece pertama (Â±16â€“64 KB)
    </div>
    <div class="progress">
      <div class="bar"></div>
    </div>
    <div class="file" id="file"></div>
  `;
  container.appendChild(card);

  const bar = card.querySelector(".bar");
  const stat = card.querySelector("#stat");
  const fileBox = card.querySelector("#file");

  client.add(article.magnet, { announce: ANNOUNCE }, torrent => {

    torrent.on("download", () => {
      const percent = Math.floor(torrent.progress * 100);
      bar.style.width = percent + "%";

      stat.textContent =
        percent + "% â€¢ " +
        formatBytes(torrent.downloaded) + " / " +
        formatBytes(torrent.length) +
        " â€¢ " +
        (torrent.downloadSpeed / 1024).toFixed(1) + " KB/s â€¢ " +
        torrent.numPeers + " peer";
    });

    torrent.on("wire", () => {
      if (torrent.downloaded === 0) {
        stat.textContent =
          "0% â€¢ peer terhubung, menunggu data (Â±16â€“64 KB)";
      }
    });

    torrent.on("done", () => {
      stat.textContent = "Selesai â€¢ ikut seeding ke user lain";

      torrent.files.forEach(file => {
        file.appendTo(fileBox);
      });
    });

  });

})
.catch(err => {
  container.textContent = "Gagal memuat data.";
  console.error(err);
});
</script>

</body>
</html>