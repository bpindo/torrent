<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Viewer Konten P2P</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #020617;
  color: #e5e7eb;
  max-width: 760px;
  margin: auto;
  padding: 20px;
}
h1 { font-size: 1.4rem; }
.card {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
  margin-top: 15px;
}
.progress {
  height: 10px;
  background: #020617;
  border-radius: 6px;
  overflow: hidden;
}
.bar {
  height: 100%;
  width: 0%;
  background: #38bdf8;
}
.small { font-size: 0.9rem; opacity: 0.8; }
.file { margin-top: 10px; }
</style>
</head>

<body>

<h1>ðŸ“„ Viewer Konten Terdistribusi</h1>
<p class="small">
Konten ini dimuat melalui jaringan P2P browser (WebTorrent).
</p>

<div id="content"></div>

<script>
const POPULAR_JSON_URL = "./popular.json";

const ANNOUNCE = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.fastcast.nz"
];

const client = new WebTorrent();
const container = document.getElementById("content");

fetch(POPULAR_JSON_URL)
.then(r => r.json())
.then(data => {
  if (!data.articles || !data.articles.length) {
    container.textContent = "Konten belum tersedia.";
    return;
  }

  // Ambil 1 konten teratas (paling prioritas)
  const article = data.articles[0];

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <b>${article.title}</b>
    <div class="small">Mengunduh via P2Pâ€¦</div>
    <div class="progress"><div class="bar"></div></div>
    <div class="small" id="stat">0%</div>
    <div class="file" id="file"></div>
  `;
  container.appendChild(card);

  const bar = card.querySelector(".bar");
  const stat = card.querySelector("#stat");
  const fileBox = card.querySelector("#file");

  client.add(article.magnet, { announce: ANNOUNCE }, torrent => {

    torrent.on("download", () => {
      const p = Math.round(torrent.progress * 100);
      bar.style.width = p + "%";
      stat.textContent =
        p + "% â€¢ " +
        (torrent.downloadSpeed/1024).toFixed(1) + " KB/s â€¢ " +
        torrent.numPeers + " peer";
    });

    torrent.on("done", () => {
      stat.textContent = "Selesai â€¢ sekarang ikut seeding";

      torrent.files.forEach(file => {
        file.appendTo(fileBox);
      });
    });
  });

})
.catch(() => {
  container.textContent = "Gagal memuat data.";
});
</script>

</body>
</html>