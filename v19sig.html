<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebTorrent P2P Share + Chat</title>

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bpindo/p2p-helper@main/style.css">

<style>
/* ===== UPDATE LOG ===== */
#update-log {
  margin-top: 20px;
  padding: 10px;
  border: 1px solid #ddd;
  background: #f9f9f9;
  height: 150px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 13px;
}
#update-log .log-entry {
  margin-bottom: 4px;
  border-bottom: 1px solid #eee;
  padding-bottom: 2px;
}

/* ===== CHAT ===== */
#p2p-chat {
  margin-top: 30px;
  padding: 15px;
  background: #111;
  color: #0f0;
  font-family: monospace;
}
#p2p-chat input,
#p2p-chat button {
  width: 100%;
  margin: 6px 0;
  background: #000;
  color: #0f0;
  border: 1px solid #0f0;
  padding: 8px;
}
#p2p-chat pre {
  background: #000;
  padding: 10px;
  height: 260px;
  overflow: auto;
}
</style>
</head>

<body>

<h2>üì§ WebTorrent P2P Share</h2>

<div class="status">
  Aplikasi web peer-to-peer berbasis <strong>WebTorrent</strong> untuk berbagi file langsung dari browser ke browser.
</div>

<div class="input-row">
  <label class="file-btn" for="fileInput">üìÅ Choose File</label>
  <input type="file" id="fileInput" onchange="autoSeed()" />
  <input type="text" id="magnet" placeholder="Tempel magnet / hash (BTIH)" />
</div>

<input type="hidden" id="hashOnly" />

<div class="btn-row">
  <button class="btn-edit hidden" id="shareBtn" onclick="shareMagnet()">üì£ Share Torrent</button>
  <button class="btn-copy hidden" id="copyBtn" onclick="copyMagnet()">üìã Salin ID</button>
</div>

<div id="telegram-preview" class="log-card">Log Telegram akan muncul di sini...</div>
<button class="btn-download hidden" id="downloadBtn" onclick="download()">‚¨áÔ∏è Download</button>

<div id="info" class="status">‚ÑπÔ∏è Belum ada aktivitas</div>

<pre id="log" style="display:none"></pre>

<div id="update-log">
  <strong>Update Log</strong><br>
</div>

<!-- ================================================= -->
<!-- ================= P2P CHAT ===================== -->
<!-- ================================================= -->

<div id="p2p-chat">
  <h3>üåê P2P Chat Multi User</h3>
  <div><b>ID kamu:</b> <span id="p2p-id"></span></div>

  <input id="p2p-msg" placeholder="Tulis pesan..." disabled>
  <button id="p2p-send" disabled>Kirim</button>

  <pre id="p2p-log"></pre>
</div>

<!-- ================================================= -->
<!-- ================= CHAT SCRIPT =================== -->
<!-- ================================================= -->
<script>
/* ===== ISOLATED P2P CHAT ===== */
const p2pId = "user" + Math.floor(Math.random() * 10000);
document.getElementById("p2p-id").textContent = p2pId;

const p2pLog = document.getElementById("p2p-log");
const p2pMsg = document.getElementById("p2p-msg");
const p2pSend = document.getElementById("p2p-send");

function p2pAdd(msg) {
  p2pLog.textContent += msg + "\n";
  p2pLog.scrollTop = p2pLog.scrollHeight;
}

const SIGNALING_HOST = "p2p-chat-production-3693.up.railway.app";
const WS_URL =
  location.protocol === "https:"
    ? "wss://" + SIGNALING_HOST
    : "ws://" + SIGNALING_HOST;

p2pAdd("üîå Connecting " + WS_URL);

const ws = new WebSocket(WS_URL);
const peers = {};

ws.onopen = () => {
  ws.send(JSON.stringify({ type: "register", id: p2pId }));
};

ws.onmessage = e => {
  const data = JSON.parse(e.data);

  if (data.type === "peers") {
    data.peers.forEach(pid => {
      if (pid === p2pId || peers[pid]) return;
      createPeer(pid, p2pId < pid);
    });
    return;
  }

  if (data.signal) {
    if (!peers[data.from]) {
      createPeer(data.from, p2pId < data.from);
    }
    peers[data.from].signal(data.signal);
  }
};

function createPeer(pid, initiator) {
  const peer = new SimplePeer({ initiator, trickle: false });
  peers[pid] = peer;

  peer.on("signal", s => {
    ws.send(JSON.stringify({ from: p2pId, to: pid, signal: s }));
  });

  peer.on("connect", () => {
    p2pAdd("‚úÖ CONNECTED: " + pid);
    updateUI();
  });

  peer.on("data", d => {
    p2pAdd(pid + ": " + d.toString());
  });

  peer.on("close", () => {
    p2pAdd("‚ö†Ô∏è DISCONNECTED: " + pid);
    delete peers[pid];
    updateUI();
  });
}

p2pSend.onclick = () => {
  const text = p2pMsg.value.trim();
  if (!text) return;

  let sent = false;
  Object.values(peers).forEach(p => {
    if (p.connected) {
      p.send(text);
      sent = true;
    }
  });

  p2pAdd(sent ? "Kamu: " + text : "‚ö†Ô∏è Tidak ada peer");
  p2pMsg.value = "";
};

function updateUI() {
  const ready = Object.values(peers).some(p => p.connected);
  p2pMsg.disabled = !ready;
  p2pSend.disabled = !ready;
}
</script>

<!-- ================================================= -->
<!-- ========== SCRIPT WEBTORRENT + TELEGRAM ========= -->
<!-- ================================================= -->
<script>
/* ========= SELURUH SCRIPT ASLI TELEGRAM + WEBTORRENT ========= */
/* (dipersingkat di jawaban ini demi keterbacaan,
   tapi di implementasi nyata PASTE PUNYA KAMU DI SINI TANPA DIUBAH) */
</script>

</body>
</html>