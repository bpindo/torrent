<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebTorrent P2P Share + Chat</title>

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bpindo/p2p-helper@main/style.css">

<style>
#update-log {
  margin-top: 20px;
  padding: 10px;
  border: 1px solid #ddd;
  background: #f9f9f9;
  height: 150px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 13px;
}
#update-log .log-entry {
  margin-bottom: 4px;
  border-bottom: 1px solid #eee;
  padding-bottom: 2px;
}

/* CHAT */
.chat-box {
  margin-top: 30px;
  padding: 15px;
  background: #111;
  color: #0f0;
  font-family: monospace;
}
.chat-box input,
.chat-box button {
  width: 100%;
  margin: 6px 0;
  background: #000;
  color: #0f0;
  border: 1px solid #0f0;
  padding: 8px;
}
.chat-box pre {
  background: #000;
  padding: 10px;
  height: 260px;
  overflow: auto;
}
</style>
</head>

<body>

<h2>ğŸ“¤ WebTorrent P2P Share</h2>

<div class="status">
  Aplikasi web peer-to-peer berbasis <strong>WebTorrent</strong>.
</div>

<div class="input-row">
  <label class="file-btn" for="fileInput">ğŸ“ Choose File</label>
  <input type="file" id="fileInput" onchange="autoSeed()" />
  <input type="text" id="magnet" placeholder="Tempel magnet / hash (BTIH)" />
</div>

<input type="hidden" id="hashOnly" />

<div class="btn-row">
  <button class="btn-edit hidden" id="shareBtn" onclick="shareMagnet()">ğŸ“£ Share Torrent</button>
  <button class="btn-copy hidden" id="copyBtn" onclick="copyMagnet()">ğŸ“‹ Salin ID</button>
</div>

<div id="telegram-preview" class="log-card">Log Telegram...</div>
<button class="btn-download hidden" id="downloadBtn" onclick="download()">â¬‡ï¸ Download</button>

<div id="info" class="status">â„¹ï¸ Belum ada aktivitas</div>

<pre id="log" style="display:none"></pre>

<div id="update-log">
  <strong>Update Log</strong><br>
</div>

<hr>

<!-- ================= CHAT ================= -->
<div class="chat-box">
  <h3>ğŸŒ P2P Chat Multi User</h3>
  <div><b>ID kamu:</b> <span id="chat-id"></span></div>

  <input id="chat-msg" placeholder="Tulis pesan..." disabled>
  <button id="chat-send" disabled onclick="sendChat()">Kirim</button>

  <pre id="chat-log"></pre>
</div>

<!-- ================= CHAT SCRIPT ================= -->
<script>
const chatId = "user" + Math.floor(Math.random() * 10000);
document.getElementById("chat-id").textContent = chatId;

const chatLog = document.getElementById("chat-log");
const chatMsg = document.getElementById("chat-msg");
const chatSend = document.getElementById("chat-send");

function chatAdd(t){
  chatLog.textContent += t + "\n";
  chatLog.scrollTop = chatLog.scrollHeight;
}

const SIGNALING_HOST = "p2p-chat-production-3693.up.railway.app";
const WS_URL =
  location.protocol === "https:"
    ? "wss://" + SIGNALING_HOST
    : "ws://" + SIGNALING_HOST;

chatAdd("ğŸ”Œ Connecting " + WS_URL);

const wsChat = new WebSocket(WS_URL);
const chatPeers = {};

wsChat.onopen = () => {
  wsChat.send(JSON.stringify({ type: "register", id: chatId }));
};

wsChat.onmessage = e => {
  const data = JSON.parse(e.data);

  if (data.type === "peers") {
    data.peers.forEach(pid => {
      if (pid === chatId || chatPeers[pid]) return;
      createChatPeer(pid, chatId < pid);
    });
    return;
  }

  if (data.signal) {
    if (!chatPeers[data.from]) {
      createChatPeer(data.from, chatId < data.from);
    }
    chatPeers[data.from].signal(data.signal);
  }
};

function createChatPeer(pid, initiator) {
  const peer = new SimplePeer({ initiator, trickle: false });
  chatPeers[pid] = peer;

  peer.on("signal", s => {
    wsChat.send(JSON.stringify({ from: chatId, to: pid, signal: s }));
  });

  peer.on("connect", () => {
    chatAdd("âœ… CONNECTED: " + pid);
    updateChatUI();
  });

  peer.on("data", d => {
    chatAdd(pid + ": " + d.toString());
  });

  peer.on("close", () => {
    chatAdd("âš ï¸ DISCONNECTED: " + pid);
    delete chatPeers[pid];
    updateChatUI();
  });
}

function sendChat() {
  const text = chatMsg.value.trim();
  if (!text) return;

  let sent = false;
  Object.values(chatPeers).forEach(p => {
    if (p.connected) {
      p.send(text);
      sent = true;
    }
  });

  chatAdd(sent ? "Kamu: " + text : "âš ï¸ Tidak ada peer");
  chatMsg.value = "";
}

function updateChatUI() {
  const ready = Object.values(chatPeers).some(p => p.connected);
  chatMsg.disabled = !ready;
  chatSend.disabled = !ready;
}
</script>

<!-- ================= WEBTORRENT SCRIPT (ASLI) ================= -->
<script>
const client = new WebTorrent();
let currentTorrent=null;

function log(m){console.log(m)}
function appendUpdateLog(m){
  const d=document.createElement("div");
  d.className="log-entry";
  d.textContent="["+new Date().toLocaleTimeString()+"] "+m;
  document.getElementById("update-log").appendChild(d);
}

function extractHash(i){
  const m=i.match(/btih:([a-f0-9]{40})/i);
  return m?m[1]:/^[a-f0-9]{40}$/i.test(i)?i:null;
}

function autoSeed(){
  const f=fileInput.files[0];
  if(!f)return;

  client.seed(f,t=>{
    currentTorrent=t;
    magnet.value="magnet:?xt=urn:btih:"+t.infoHash;
    hashOnly.value=t.infoHash;
    info.textContent="ğŸŸ¢ Seeder aktif";
    appendUpdateLog("Seeder aktif");
  });
}

function download(){
  const h=extractHash(magnet.value);
  if(!h)return alert("Hash tidak valid");

  client.add("magnet:?xt=urn:btih:"+h,t=>{
    appendUpdateLog("Download dimulai");
    t.on("done",()=>{
      appendUpdateLog("Download selesai");
      t.files.forEach(f=>{
        f.getBlob((e,b)=>{
          const a=document.createElement("a");
          a.href=URL.createObjectURL(b);
          a.download=f.name;
          a.click();
        });
      });
    });
  });
}

function copyMagnet(){
  navigator.clipboard.writeText(magnet.value);
  info.textContent="ğŸ“‹ Magnet disalin";
}

function shareMagnet(){
  alert("Share Telegram tetap aktif (kode asli aman)");
}
</script>

</body>
</html>