<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>P2P Chat Multi User (GitHub Safe)</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: monospace;
  background:#111;
  color:#0f0;
  padding:15px;
}
input, button {
  width:100%;
  margin:6px 0;
  background:#000;
  color:#0f0;
  border:1px solid #0f0;
  padding:8px;
}
button:disabled {
  opacity:0.5;
}
pre {
  background:#000;
  padding:10px;
  height:260px;
  overflow:auto;
}
</style>
</head>

<body>

<h3>ğŸŒ P2P Chat Multi User</h3>

<div><b>ID kamu:</b> <span id="id"></span></div>

<input id="msg" placeholder="Tulis pesan..." disabled>
<button id="sendBtn" onclick="send()" disabled>Kirim</button>

<pre id="log"></pre>

<!-- SIMPLE PEER -->
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

<script>
/* ======================
   ID & UI
====================== */
const myId = "user" + Math.floor(Math.random() * 10000);
document.getElementById("id").textContent = myId;

const logEl = document.getElementById("log");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");

function log(t) {
  logEl.textContent += t + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

/* ======================
   AUTO WS / WSS (GITHUB SAFE)
====================== */
const SIGNALING_HOST = "p2p-chat-production-3693.up.railway.app";

const WS_URL =
  location.protocol === "https:"
    ? "wss://" + SIGNALING_HOST
    : "ws://" + SIGNALING_HOST;

log("ğŸ”Œ Connecting to " + WS_URL);

const ws = new WebSocket(WS_URL);

/* ======================
   PEERS
====================== */
const peers = {}; // peerId -> SimplePeer

ws.onopen = () => {
  log("âœ… CONNECTED signaling");
  ws.send(JSON.stringify({
    type: "register",
    id: myId
  }));
};

ws.onmessage = e => {
  const data = JSON.parse(e.data);

  // daftar peer
  if (data.type === "peers") {
    data.peers.forEach(pid => {
      if (pid === myId || peers[pid]) return;

      const initiator = myId < pid;
      log("â³ Membuat peer ke " + pid);

      const peer = new SimplePeer({
        initiator,
        trickle: false
      });

      setupPeer(peer, pid);
      peers[pid] = peer;
    });
    return;
  }

  // signaling
  if (data.signal) {
    if (!peers[data.from]) {
      const initiator = myId < data.from;
      log("â³ Peer auto dibuat dari " + data.from);

      const peer = new SimplePeer({
        initiator,
        trickle: false
      });

      setupPeer(peer, data.from);
      peers[data.from] = peer;
    }

    try {
      peers[data.from].signal(data.signal);
    } catch (err) {
      log("âŒ Signal error dari " + data.from);
    }
  }
};

/* ======================
   PEER HANDLER
====================== */
function setupPeer(peer, pid) {

  peer.on("signal", s => {
    ws.send(JSON.stringify({
      from: myId,
      to: pid,
      signal: s
    }));
  });

  peer.on("connect", () => {
    log("âœ… CONNECTED: " + pid);
    updateUI();
  });

  peer.on("data", d => {
    log(pid + ": " + d.toString());
  });

  peer.on("close", () => {
    log("âš ï¸ DISCONNECTED: " + pid);
    delete peers[pid];
    updateUI();
  });

  peer.on("error", err => {
    log("âŒ ERROR (" + pid + "): " + err.message);
  });
}

/* ======================
   SEND MESSAGE
====================== */
function send() {
  const text = msgInput.value.trim();
  if (!text) return;

  let sent = 0;
  Object.values(peers).forEach(p => {
    if (p.connected) {
      p.send(text);
      sent++;
    }
  });

  if (sent > 0) {
    log("Kamu: " + text);
  } else {
    log("âš ï¸ Tidak ada peer siap");
  }

  msgInput.value = "";
}

/* ======================
   UI STATE
====================== */
function updateUI() {
  const ready = Object.values(peers).some(p => p.connected);
  msgInput.disabled = !ready;
  sendBtn.disabled = !ready;
}
</script>

</body>
</html>
